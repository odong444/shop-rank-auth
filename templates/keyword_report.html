{% extends "base.html" %}

{% block title %}í‚¤ì›Œë“œ ë¶„ì„ ë³´ê³ ì„œ{% endblock %}
{% block header_title %}ğŸ“ í‚¤ì›Œë“œ ë¶„ì„ ë³´ê³ ì„œ{% endblock %}

{% block header_right %}
<span id="serverStatus" class="server-status offline">â— ì„œë²„ í™•ì¸ì¤‘</span>
<span style="font-size:14px;color:#666">ğŸ‘¤ {{ session.name }}ë‹˜</span>
{% endblock %}

{% block extra_css %}
<style>
.analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
@media (max-width: 900px) { .analysis-grid { grid-template-columns: 1fr; } }

.stat-box { background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center; }
.stat-box .value { font-size: 24px; font-weight: bold; color: #667eea; }
.stat-box .label { font-size: 12px; color: #888; margin-top: 5px; }

.keyword-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
.keyword-table th, .keyword-table td { padding: 8px 10px; border: 1px solid #e0e0e0; text-align: left; }
.keyword-table th { background: #f5f5f5; font-weight: 600; }
.keyword-table tr:hover { background: #fafafa; }

.ai-box { background: linear-gradient(135deg, #667eea20, #764ba220); border: 1px solid #667eea40; border-radius: 8px; padding: 20px; margin-top: 15px; }
.ai-box h4 { color: #667eea; margin-bottom: 15px; }
.ai-tag { display: inline-block; background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 5px; }

.strategy-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-top: 10px; }
.strategy-card h5 { color: #333; margin-bottom: 10px; font-size: 14px; }
.strategy-card p { color: #666; font-size: 13px; line-height: 1.6; }

.difficulty-high { color: #e74c3c; font-weight: bold; }
.difficulty-mid { color: #f39c12; font-weight: bold; }
.difficulty-low { color: #27ae60; font-weight: bold; }

.progress-step { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
.progress-step .step-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.progress-step .step-icon.done { background: #27ae60; color: white; }
.progress-step .step-icon.loading { background: #667eea; color: white; animation: pulse 1s infinite; }
.progress-step .step-icon.pending { background: #ddd; color: #888; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

.checkbox-option { display: flex; align-items: center; gap: 8px; margin: 10px 0; }
.checkbox-option input[type="checkbox"] { width: 18px; height: 18px; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>ğŸ” í‚¤ì›Œë“œ ë¶„ì„</h3></div>
    <div class="card-body">
        <div class="search-box">
            <input type="text" id="mainKeyword" placeholder="ë¶„ì„í•  ë©”ì¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¬ê³¼, ë¬¼í‹°ìŠˆ)" style="flex:1">
            <button onclick="analyzeKeyword()" id="analyzeBtn">ë¶„ì„ ì‹œì‘</button>
        </div>
        <div class="checkbox-option">
            <input type="checkbox" id="includeAI" checked>
            <label for="includeAI">ğŸ¤– AI ì„œë¸Œí‚¤ì›Œë“œ ë¶„ì„ í¬í•¨ (Claude API ì‚¬ìš©)</label>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888">* AI ë¶„ì„ í¬í•¨ ì‹œ ë” ì •í™•í•œ ì„œë¸Œí‚¤ì›Œë“œ ì¶”ì²œê³¼ ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤</p>
    </div>
</div>

<!-- ì§„í–‰ ìƒí™© -->
<div class="card" id="progressCard" style="display:none">
    <div class="card-header"><h3>â³ ë¶„ì„ ì§„í–‰ ì¤‘...</h3></div>
    <div class="card-body">
        <div id="progressSteps">
            <div class="progress-step" data-step="1">
                <div class="step-icon pending">1</div>
                <span>ê²€ìƒ‰ëŸ‰ ë° ì—°ê´€ í‚¤ì›Œë“œ ì¡°íšŒ</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-icon pending">2</div>
                <span>ì½˜í…ì¸  ë° ìƒí’ˆ ë°ì´í„° ìˆ˜ì§‘</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-icon pending">3</div>
                <span>ìƒìœ„ ìŠ¤í† ì–´ ì›”ê°„ ë§¤ì¶œ ì¡°íšŒ</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-icon pending">4</div>
                <span>AI ì„œë¸Œí‚¤ì›Œë“œ ë¶„ì„</span>
            </div>
        </div>
    </div>
</div>

<!-- ë¶„ì„ ê²°ê³¼ -->
<div id="resultSection" style="display:none">
    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card">
        <div class="card-header"><h3>ğŸ“Š <span id="resultKeyword"></span> ë¶„ì„ ê²°ê³¼</h3></div>
        <div class="card-body">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px">
                <div class="stat-box">
                    <div class="value" id="totalVolume">-</div>
                    <div class="label">ì›”ê°„ ê²€ìƒ‰ëŸ‰</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="pcVolume">-</div>
                    <div class="label">PC ê²€ìƒ‰ëŸ‰</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="mobileVolume">-</div>
                    <div class="label">ëª¨ë°”ì¼ ê²€ìƒ‰ëŸ‰</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="competition">-</div>
                    <div class="label">ê²½ìŸ ê°•ë„</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="productCount">-</div>
                    <div class="label">ë“±ë¡ ìƒí’ˆ ìˆ˜</div>
                </div>
            </div>
        </div>
    </div>

    <div class="analysis-grid">
        <!-- ì—°ê´€ í‚¤ì›Œë“œ -->
        <div class="card">
            <div class="card-header"><h3>ğŸ”— ì—°ê´€ í‚¤ì›Œë“œ TOP 10</h3></div>
            <div class="card-body">
                <table class="keyword-table">
                    <thead><tr><th>#</th><th>í‚¤ì›Œë“œ</th><th>ê²€ìƒ‰ëŸ‰</th><th>ê²½ìŸ</th></tr></thead>
                    <tbody id="relatedKeywords"></tbody>
                </table>
            </div>
        </div>

        <!-- ìƒìœ„ ë§¤ì¶œ -->
        <div class="card">
            <div class="card-header"><h3>ğŸ’° ìƒìœ„ ìŠ¤í† ì–´ ì›”ê°„ ë§¤ì¶œ</h3></div>
            <div class="card-body">
                <table class="keyword-table">
                    <thead><tr><th>#</th><th>ìŠ¤í† ì–´</th><th>ì›”ê°„ ë§¤ì¶œ</th></tr></thead>
                    <tbody id="topSales"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI ë¶„ì„ ê²°ê³¼ -->
    <div class="card" id="aiResultCard" style="display:none">
        <div class="card-header"><h3>ğŸ¤– AI ì„œë¸Œí‚¤ì›Œë“œ ë¶„ì„</h3></div>
        <div class="card-body">
            <div class="ai-box">
                <h4><span class="ai-tag">AI</span> ì¶”ì²œ ì„œë¸Œí‚¤ì›Œë“œ</h4>
                <table class="keyword-table">
                    <thead><tr><th>í‚¤ì›Œë“œ</th><th>ê²€ìƒ‰ëŸ‰</th><th>ìƒí’ˆìˆ˜</th><th>ìƒìœ„ë§¤ì¶œ</th><th>ì§„ì…ë‚œì´ë„</th><th>ì¶”ì²œì´ìœ </th></tr></thead>
                    <tbody id="aiKeywords"></tbody>
                </table>
            </div>

            <div class="strategy-card" id="strategyCard">
                <h5>ğŸ“‹ ì „ëµ ì œì•ˆ</h5>
                <div id="strategyContent"></div>
            </div>

            <div class="ai-box" style="margin-top:20px" id="aiSummaryBox">
                <h4><span class="ai-tag">AI</span> ì¢…í•© ë¶„ì„</h4>
                <div id="aiSummary" style="white-space:pre-wrap;line-height:1.8"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const RANK_API_URL = '{{ rank_api_url }}';

async function checkServer() {
    const status = document.getElementById('serverStatus');
    try {
        const r = await fetch(RANK_API_URL + '/health', {method: 'GET', mode: 'cors'});
        if (r.ok) {
            status.className = 'server-status online';
            status.textContent = 'â— ì„œë²„ ì—°ê²°ë¨';
            return true;
        }
    } catch(e) {}
    status.className = 'server-status offline';
    status.textContent = 'â— ì„œë²„ ì˜¤í”„ë¼ì¸';
    return false;
}

function updateProgress(step, status) {
    const stepEl = document.querySelector(`[data-step="${step}"] .step-icon`);
    if (stepEl) {
        stepEl.className = 'step-icon ' + status;
        if (status === 'done') stepEl.textContent = 'âœ“';
    }
}

function formatNumber(num) {
    if (!num) return '-';
    return parseInt(num).toLocaleString();
}

let currentData = null; // í˜„ì¬ ë¶„ì„ ë°ì´í„° ì €ì¥

async function analyzeKeyword() {
    const keyword = document.getElementById('mainKeyword').value.trim();
    const includeAI = document.getElementById('includeAI').checked;
    const btn = document.getElementById('analyzeBtn');

    if (!keyword) {
        alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // UI ì´ˆê¸°í™”
    btn.disabled = true;
    btn.textContent = 'ë¶„ì„ ì¤‘...';
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('aiResultCard').style.display = 'none';

    // ì§„í–‰ ìƒíƒœ ì´ˆê¸°í™”
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.querySelector(`[data-step="${i}"] .step-icon`);
        stepEl.className = 'step-icon pending';
        stepEl.textContent = i;
    }

    // 4ë‹¨ê³„ëŠ” AI í¬í•¨ì‹œë§Œ í‘œì‹œ
    document.querySelector('[data-step="4"]').style.display = includeAI ? 'flex' : 'none';

    try {
        // Step 1-2: ê¸°ë³¸ ë°ì´í„° ìˆ˜ì§‘
        updateProgress(1, 'loading');

        const response = await fetch('/api/keyword-report/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keyword, include_ai: includeAI})
        });

        const result = await response.json();

        if (result.success) {
            // Step 1-2 ì™„ë£Œ
            updateProgress(1, 'done');
            updateProgress(2, 'done');

            currentData = result.data;
            renderResults(result.data);

            // Step 3: ë§¤ì¶œ ì¡°íšŒ (ë³„ë„ ë¹„ë™ê¸° - ì‹œê°„ ì†Œìš”)
            if (result.data.sales_available) {
                updateProgress(3, 'loading');
                runSalesAnalysis(result.data.top_products);
            } else {
                updateProgress(3, 'done');
            }

            // Step 4: AI ë¶„ì„ (ë³„ë„ ìš”ì²­)
            if (includeAI && result.data.ai_available) {
                updateProgress(4, 'loading');
                runAIAnalysis(keyword, result.data.related_keywords);
            }
        } else {
            alert('ë¶„ì„ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch(e) {
        console.error(e);
        alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ë¶„ì„ ì‹œì‘';
    }
}

async function runSalesAnalysis(products) {
    try {
        const response = await fetch('/api/keyword-report/sales', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ products: products })
        });

        const result = await response.json();

        if (result.success && result.monthly_sales && result.monthly_sales.length > 0) {
            updateProgress(3, 'done');
            // ë§¤ì¶œ ë°ì´í„° ë Œë”ë§
            const salesTbody = document.getElementById('topSales');
            salesTbody.innerHTML = '';
            result.monthly_sales.forEach((s, i) => {
                salesTbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td>${s.mall}</td>
                    <td>${formatNumber(s.total_amount)}ì›</td>
                </tr>`;
            });
            if (currentData) currentData.monthly_sales = result.monthly_sales;
        } else {
            updateProgress(3, 'done');
            console.log('ë§¤ì¶œ ë°ì´í„° ì—†ìŒ');
        }
    } catch(e) {
        updateProgress(3, 'done');
        console.error('ë§¤ì¶œ ì¡°íšŒ ì˜¤ë¥˜:', e);
    }
}

async function runAIAnalysis(keyword, relatedKeywords) {
    try {
        const response = await fetch('/api/keyword-report/ai-analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                keyword: keyword,
                related_keywords: relatedKeywords,
                keyword_data: {}
            })
        });

        const result = await response.json();

        if (result.success && result.analysis) {
            updateProgress(4, 'done');
            renderAIResults(result.analysis);
        } else {
            updateProgress(4, 'pending');
            console.log('AI ë¶„ì„ ì‹¤íŒ¨:', result.error);
        }
    } catch(e) {
        updateProgress(4, 'pending');
        console.error('AI ë¶„ì„ ì˜¤ë¥˜:', e);
    }
}

function renderAIResults(analysis) {
    const aiCard = document.getElementById('aiResultCard');
    aiCard.style.display = 'block';

    const aiTbody = document.getElementById('aiKeywords');
    aiTbody.innerHTML = '';

    (analysis.recommended_keywords || []).forEach(kw => {
        const diffClass = kw.entry_difficulty === 'ìƒ' ? 'difficulty-high' :
                         (kw.entry_difficulty === 'ì¤‘' ? 'difficulty-mid' : 'difficulty-low');
        aiTbody.innerHTML += `<tr>
            <td><strong>${kw.keyword}</strong></td>
            <td>${formatNumber(kw.search_volume)}</td>
            <td>${formatNumber(kw.product_count)}</td>
            <td>${formatNumber(kw.top_monthly_sales)}ì›</td>
            <td class="${diffClass}">${kw.entry_difficulty}</td>
            <td style="font-size:12px">${kw.reason}</td>
        </tr>`;
    });

    // ì „ëµ ì œì•ˆ
    const strategy = analysis.strategy || {};
    document.getElementById('strategyContent').innerHTML = `
        <p><strong>ğŸ¯ ìš°ì„  ê³µëµ í‚¤ì›Œë“œ:</strong> ${strategy.priority_keyword || '-'}</p>
        <p style="margin-top:8px;color:#666">${strategy.priority_reason || ''}</p>
        <hr style="margin:15px 0;border:none;border-top:1px solid #eee">
        <p><strong>ë©”ì¸ í‚¤ì›Œë“œ í™œìš©:</strong> ${strategy.main_keyword_usage || '-'}</p>
        <p style="margin-top:8px"><strong>ì„œë¸Œ í‚¤ì›Œë“œ í™œìš©:</strong> ${strategy.sub_keyword_usage || '-'}</p>
    `;

    // AI ìš”ì•½
    if (analysis.summary) {
        document.getElementById('aiSummary').textContent = analysis.summary;
        document.getElementById('aiSummaryBox').style.display = 'block';
    }

    aiCard.scrollIntoView({behavior: 'smooth'});
}

function renderResults(data) {
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('resultKeyword').textContent = data.keyword;

    // ê¸°ë³¸ ì •ë³´
    const sv = data.search_volume || {};
    document.getElementById('totalVolume').textContent = formatNumber(sv.total);
    document.getElementById('pcVolume').textContent = formatNumber(sv.pc);
    document.getElementById('mobileVolume').textContent = formatNumber(sv.mobile);
    document.getElementById('competition').textContent = sv.competition || '-';
    document.getElementById('productCount').textContent = formatNumber(data.content_counts?.shop);

    // ì—°ê´€ í‚¤ì›Œë“œ
    const relatedTbody = document.getElementById('relatedKeywords');
    relatedTbody.innerHTML = '';
    (data.related_keywords || []).slice(0, 10).forEach((kw, i) => {
        relatedTbody.innerHTML += `<tr>
            <td>${i+1}</td>
            <td>${kw.keyword}</td>
            <td>${formatNumber(kw.volume)}</td>
            <td>${kw.competition}</td>
        </tr>`;
    });

    // ìƒìœ„ ë§¤ì¶œ
    const salesTbody = document.getElementById('topSales');
    salesTbody.innerHTML = '';
    (data.monthly_sales || []).forEach((s, i) => {
        salesTbody.innerHTML += `<tr>
            <td>${i+1}</td>
            <td>${s.mall}</td>
            <td>${formatNumber(s.total_amount)}ì›</td>
        </tr>`;
    });
    if (!data.monthly_sales?.length) {
        salesTbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888">ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</td></tr>';
    }

    // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('resultSection').scrollIntoView({behavior: 'smooth'});
}

document.getElementById('mainKeyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') analyzeKeyword();
});

checkServer();
setInterval(checkServer, 30000);
</script>
{% endblock %}
