{% extends "base.html" %}
{% block title %}í‚¤ì›Œë“œ ë¦¬í¬íŠ¸{% endblock %}

{% block extra_css %}
<style>
.search-box { 
    display: flex; 
    gap: 8px; 
    margin-bottom: 16px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}
.search-box .input { flex: 1; text-align: center; }
.report-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}
.card-title {
    font-size: 0.938rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.card-title::before {
    content: '';
    width: 4px;
    height: 16px;
    background: var(--primary);
    border-radius: 2px;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}
.stat-box {
    background: var(--bg-gray);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
}
.stat-label {
    font-size: 0.688rem;
    color: var(--text-gray);
    margin-bottom: 4px;
}
.stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
}
.simple-table {
    width: 100%;
    font-size: 0.813rem;
    border-collapse: collapse;
}
.simple-table th {
    background: var(--bg-gray);
    color: var(--text-gray);
    font-weight: 600;
    padding: 8px 6px;
    text-align: left;
    font-size: 0.75rem;
}
.simple-table td {
    padding: 10px 6px;
    border-bottom: 1px solid var(--border);
    color: var(--text-dark);
}
.product-card {
    display: flex;
    gap: 12px;
    background: var(--bg-gray);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
}
.product-img {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
}
.product-info { flex: 1; min-width: 0; }
.product-title-text {
    font-size: 0.813rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
.product-meta {
    font-size: 0.688rem;
    color: var(--text-gray);
    margin-bottom: 6px;
}
.product-scores {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}
.score-badge {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.625rem;
    font-weight: 600;
    color: var(--text-gray);
}
.score-badge.high {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--primary);
    color: var(--primary);
}
.btn-download {
    background: var(--primary);
    color: #fff;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.938rem;
    width: 100%;
    margin-top: 16px;
}
.btn-download:hover { background: var(--primary-light); }
.empty-state {
    text-align: center;
    padding: 64px 16px;
    color: var(--text-gray);
}
</style>
{% endblock %}

{% block content %}
<div class="search-box">
    <input type="text" id="keywordInput" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ë¬¼í‹°ìŠˆ)" class="input">
    <button onclick="analyzeKeyword()" id="searchBtn" class="btn btn-primary">ë¶„ì„</button>
</div>

<div id="loading" class="hidden" style="text-align: center; padding: 80px 16px;">
    <div class="spinner" style="width: 60px; height: 60px; border-width: 6px; margin: 0 auto;"></div>
    <p style="margin-top: 24px; font-size: 1.125rem; font-weight: 600; color: var(--text-dark);">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
    <p style="margin-top: 8px; font-size: 0.875rem; color: var(--text-gray);">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
</div>

<div id="error" class="error-box hidden">
    <p id="errorMsg"></p>
</div>

<div id="resultArea" class="hidden">
    <div class="report-card">
        <div class="card-title">ğŸ“Š ê²€ìƒ‰ëŸ‰</div>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">ì´ ê²€ìƒ‰ëŸ‰</div>
                <div class="stat-value" id="totalVolume">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ê²½ìŸë„</div>
                <div class="stat-value" id="competition" style="font-size: 1rem;">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PC</div>
                <div class="stat-value" id="pcVolume" style="font-size: 0.938rem; color: var(--text-dark);">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ëª¨ë°”ì¼</div>
                <div class="stat-value" id="mobileVolume" style="font-size: 0.938rem; color: var(--text-dark);">0</div>
            </div>
        </div>
    </div>

    <div class="report-card">
        <div class="card-title">ğŸ“ ì½˜í…ì¸  ìˆ˜</div>
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-box">
                <div class="stat-label">ë¸”ë¡œê·¸</div>
                <div class="stat-value" id="blogCount" style="font-size: 0.875rem; color: var(--text-dark);">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ì¹´í˜</div>
                <div class="stat-value" id="cafeCount" style="font-size: 0.875rem; color: var(--text-dark);">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ì‡¼í•‘</div>
                <div class="stat-value" id="shopCount" style="font-size: 0.875rem; color: var(--text-dark);">0</div>
            </div>
        </div>
    </div>

    <div class="report-card">
        <div class="card-title">ğŸ”— ì—°ê´€ í‚¤ì›Œë“œ TOP 5</div>
        <table class="simple-table">
            <thead>
                <tr>
                    <th style="width: 50%;">í‚¤ì›Œë“œ</th>
                    <th style="width: 30%; text-align: right;">ê²€ìƒ‰ëŸ‰</th>
                    <th style="width: 20%; text-align: center;">ê²½ìŸë„</th>
                </tr>
            </thead>
            <tbody id="relatedTable">
                <tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë°ì´í„° ì—†ìŒ</td></tr>
            </tbody>
        </table>
    </div>

    <div class="report-card">
        <div class="card-title">ğŸ† ìƒìœ„ ìƒí’ˆ TOP 5</div>
        <div id="productsArea">
            <p style="text-align: center; color: var(--text-gray); padding: 24px 0;">ë°ì´í„° ì—†ìŒ</p>
        </div>
    </div>

    <div class="report-card" id="monthlySalesCard" style="display: none;">
        <div class="card-title">ğŸ’° ìƒìœ„ ìŠ¤í† ì–´ ì›”ê°„ ë§¤ì¶œ</div>
        <table class="simple-table">
            <thead>
                <tr>
                    <th style="width: 40%;">ìŠ¤í† ì–´</th>
                    <th style="width: 30%; text-align: right;">ë§¤ì¶œì•¡</th>
                    <th style="width: 30%; text-align: right;">íŒë§¤ê±´ìˆ˜</th>
                </tr>
            </thead>
            <tbody id="monthlySalesTable">
                <tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="report-card" id="dailySalesCard" style="display: none;">
        <div class="card-title">ğŸ“… ìƒìœ„ ìŠ¤í† ì–´ ì¼ê°„ ë§¤ì¶œ</div>
        <table class="simple-table">
            <thead>
                <tr>
                    <th style="width: 40%;">ìŠ¤í† ì–´</th>
                    <th style="width: 30%; text-align: right;">ë§¤ì¶œì•¡</th>
                    <th style="width: 30%; text-align: right;">íŒë§¤ê±´ìˆ˜</th>
                </tr>
            </thead>
            <tbody id="dailySalesTable">
                <tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <button onclick="downloadPDF()" class="btn-download">ğŸ“¥ PDFë¡œ ë‹¤ìš´ë¡œë“œ</button>
</div>

<div id="emptyState" class="empty-state">
    <div style="font-size: 3rem; margin-bottom: 12px;">ğŸ”</div>
    <p style="font-weight: 600; margin-bottom: 6px;">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„í•˜ì„¸ìš”</p>
    <p style="font-size: 0.813rem;">ê²€ìƒ‰ëŸ‰, ì—°ê´€ í‚¤ì›Œë“œ, ìƒìœ„ ìƒí’ˆ, ë§¤ì¶œ ë°ì´í„°ë¥¼ í•œëˆˆì—!</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = null;

function formatNumber(num) {
    try { return parseInt(num).toLocaleString(); } catch { return num; }
}

async function analyzeKeyword() {
    const keyword = document.getElementById('keywordInput').value.trim();
    const btn = document.getElementById('searchBtn');
    
    if (!keyword) {
        alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    btn.disabled = true;
    btn.textContent = 'ë¶„ì„ ì¤‘...';
    
    try {
        const response = await fetch('/api/keyword-report/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keyword: keyword})
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentData = result.data;
            displayResult(result.data);
            
            if (result.data.top_products && result.data.top_products.length > 0) {
                fetchSalesData(result.data.top_products);
            }
        } else {
            showError(result.error || 'ë¶„ì„ ì‹¤íŒ¨');
        }
    } catch (err) {
        console.error(err);
        showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    } finally {
        document.getElementById('loading').classList.add('hidden');
        btn.disabled = false;
        btn.textContent = 'ë¶„ì„';
    }
}

function displayResult(data) {
    const sv = data.search_volume;
    document.getElementById('totalVolume').textContent = formatNumber(sv.total || 0);
    document.getElementById('pcVolume').textContent = formatNumber(sv.pc || 0);
    document.getElementById('mobileVolume').textContent = formatNumber(sv.mobile || 0);
    document.getElementById('competition').textContent = sv.competition || '-';
    
    const cc = data.content_counts;
    document.getElementById('blogCount').textContent = formatNumber(cc.blog || 0);
    document.getElementById('cafeCount').textContent = formatNumber(cc.cafe || 0);
    document.getElementById('shopCount').textContent = formatNumber(cc.shop || 0);
    
    const relatedTable = document.getElementById('relatedTable');
    if (data.related_keywords && data.related_keywords.length > 0) {
        relatedTable.innerHTML = data.related_keywords.slice(0, 5).map(kw => `
            <tr>
                <td>${kw.keyword}</td>
                <td style="text-align: right;">${formatNumber(kw.volume)}</td>
                <td style="text-align: center;">${kw.competition}</td>
            </tr>
        `).join('');
    } else {
        relatedTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë°ì´í„° ì—†ìŒ</td></tr>';
    }
    
    const productsArea = document.getElementById('productsArea');
    if (data.top_products && data.top_products.length > 0) {
        productsArea.innerHTML = data.top_products.map(p => `
            <div class="product-card">
                <img src="${p.image || ''}" class="product-img" onerror="this.style.display='none'">
                <div class="product-info">
                    <div class="product-title-text">${p.title}</div>
                    <div class="product-meta">${p.mall} Â· ${formatNumber(p.price)}ì›</div>
                    <div class="product-scores">
                        <span class="score-badge ${p.relevance >= 4 ? 'high' : ''}">ì¢…í•© ${p.relevance}</span>
                        <span class="score-badge ${p.hit >= 4 ? 'high' : ''}">ì¸ê¸° ${p.hit}</span>
                        <span class="score-badge ${p.sale >= 4 ? 'high' : ''}">íŒë§¤ ${p.sale}</span>
                        <span class="score-badge">ë¦¬ë·° ${formatNumber(p.review_cnt)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        productsArea.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 24px 0;">ë°ì´í„° ì—†ìŒ</p>';
    }
    
    document.getElementById('resultArea').classList.remove('hidden');
}

async function fetchSalesData(products) {
    const monthlySalesCard = document.getElementById('monthlySalesCard');
    const monthlySalesTable = document.getElementById('monthlySalesTable');
    const dailySalesCard = document.getElementById('dailySalesCard');
    const dailySalesTable = document.getElementById('dailySalesTable');
    
    monthlySalesCard.style.display = 'block';
    dailySalesCard.style.display = 'block';
    monthlySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ì¡°íšŒ ì¤‘...</td></tr>';
    dailySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ì¡°íšŒ ì¤‘...</td></tr>';
    
    try {
        // ì›”ê°„ ë§¤ì¶œ
        const monthlyResponse = await fetch('/api/keyword-report/sales', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({products: products, period: 'monthly'})
        });
        
        const monthlyResult = await monthlyResponse.json();
        
        if (monthlyResult.success && monthlyResult.sales && monthlyResult.sales.length > 0) {
            monthlySalesTable.innerHTML = monthlyResult.sales.map(s => `
                <tr>
                    <td>${s.mall}</td>
                    <td style="text-align: right;">${formatNumber(s.amount)}ì›</td>
                    <td style="text-align: right;">${formatNumber(s.count)}ê±´</td>
                </tr>
            `).join('');
        } else {
            monthlySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</td></tr>';
        }
        
        // ì¼ê°„ ë§¤ì¶œ
        const dailyResponse = await fetch('/api/keyword-report/sales', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({products: products, period: 'daily'})
        });
        
        const dailyResult = await dailyResponse.json();
        
        if (dailyResult.success && dailyResult.sales && dailyResult.sales.length > 0) {
            dailySalesTable.innerHTML = dailyResult.sales.map(s => `
                <tr>
                    <td>${s.mall}</td>
                    <td style="text-align: right;">${formatNumber(s.amount)}ì›</td>
                    <td style="text-align: right;">${formatNumber(s.count)}ê±´</td>
                </tr>
            `).join('');
        } else {
            dailySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-gray);">ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</td></tr>';
        }
    } catch (err) {
        console.error(err);
        monthlySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #EF4444;">ì¡°íšŒ ì‹¤íŒ¨</td></tr>';
        dailySalesTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #EF4444;">ì¡°íšŒ ì‹¤íŒ¨</td></tr>';
    }
}

function showError(msg) {
    document.getElementById('error').classList.remove('hidden');
    document.getElementById('errorMsg').textContent = msg;
}

function downloadPDF() {
    if (!currentData) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    window.print();
}

document.getElementById('keywordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') analyzeKeyword();
});
</script>
{% endblock %}
