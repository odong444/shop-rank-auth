{% extends "base.html" %}

{% block title %}ìƒí’ˆì§€ìˆ˜ ì¡°íšŒ{% endblock %}
{% block header_title %}ğŸ“Š ìƒí’ˆì§€ìˆ˜ ì¡°íšŒ{% endblock %}

{% block header_right %}
<span id="usageInfo" class="usage-info"></span>
<span id="serverStatus" class="server-status offline">â— ì„œë²„ í™•ì¸ì¤‘</span>
<span style="font-size:14px;color:#666">ğŸ‘¤ {{ session.name }}ë‹˜</span>
{% endblock %}

{% block extra_css %}
<style>
.usage-info {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
}
.usage-info.unlimited {
    background: #d4edda;
    color: #155724;
}
.usage-info.limited {
    background: #fff3cd;
    color: #856404;
}
.usage-info.exhausted {
    background: #f8d7da;
    color: #721c24;
}
.upgrade-notice {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
    text-align: center;
}
.upgrade-notice.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div id="upgradeNotice" class="upgrade-notice">
    âš ï¸ ë¬´ë£Œ ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê³„ì† ì‚¬ìš©í•˜ì‹œë ¤ë©´ ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.
</div>

<div class="card">
    <div class="card-header"><h3>ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰</h3></div>
    <div class="card-body">
        <div class="search-box">
            <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¬¼í‹°ìŠˆ)">
            <button onclick="searchProducts()" id="searchBtn">ê²€ìƒ‰</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888">* ìœˆë„ìš° ë¡œì»¬ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ <span id="resultCount" style="color:#667eea"></span></h3>
    </div>
    <div class="card-body">
        <div id="loading" class="loading" style="display:none">
            <div class="spinner"></div>
            <p>ê²€ìƒ‰ ì¤‘...</p>
        </div>
        <div id="resultArea">
            <div class="empty">
                <div class="empty-icon">ğŸ”</div>
                <p>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰í•˜ì„¸ìš”.<br>ìƒí’ˆë³„ ìƒì„¸ ì ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const RANK_API_URL = '{{ rank_api_url }}';
let canUseService = true;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ëŸ‰ ì²´í¬
async function checkUsage() {
    try {
        const r = await fetch('/api/product-score/check-usage');
        const d = await r.json();
        
        if (d.success) {
            updateUsageDisplay(d);
        }
    } catch(e) {
        console.error('ì‚¬ìš©ëŸ‰ ì²´í¬ ì‹¤íŒ¨:', e);
    }
}

function updateUsageDisplay(data) {
    const usageInfo = document.getElementById('usageInfo');
    const upgradeNotice = document.getElementById('upgradeNotice');
    const searchBtn = document.getElementById('searchBtn');
    
    if (data.limit === -1) {
        // ë¬´ì œí•œ (ê³ ê°/ê´€ë¦¬ì)
        usageInfo.className = 'usage-info unlimited';
        usageInfo.textContent = 'âœ“ ë¬´ì œí•œ';
        canUseService = true;
        upgradeNotice.classList.remove('show');
        searchBtn.disabled = false;
    } else if (data.canUse) {
        // ì‚¬ìš© ê°€ëŠ¥
        usageInfo.className = 'usage-info limited';
        usageInfo.textContent = `ë‚¨ì€ íšŸìˆ˜: ${data.remaining}/${data.limit}`;
        canUseService = true;
        upgradeNotice.classList.remove('show');
        searchBtn.disabled = false;
    } else {
        // ì‚¬ìš© ë¶ˆê°€
        usageInfo.className = 'usage-info exhausted';
        usageInfo.textContent = `ì‚¬ìš© ì™„ë£Œ (${data.used}/${data.limit})`;
        canUseService = false;
        upgradeNotice.classList.add('show');
        searchBtn.disabled = true;
    }
}

async function checkServer() {
    const status = document.getElementById('serverStatus');
    try {
        const r = await fetch(RANK_API_URL + '/health', {method: 'GET', mode: 'cors'});
        if (r.ok) {
            status.className = 'server-status online';
            status.textContent = 'â— ì„œë²„ ì—°ê²°ë¨';
            return true;
        }
    } catch(e) {}
    status.className = 'server-status offline';
    status.textContent = 'â— ì„œë²„ ì˜¤í”„ë¼ì¸';
    return false;
}

async function searchProducts() {
    const keyword = document.getElementById('searchKeyword').value.trim();
    const btn = document.getElementById('searchBtn');
    const loading = document.getElementById('loading');
    const resultArea = document.getElementById('resultArea');
    const resultCount = document.getElementById('resultCount');
    
    if (!keyword) {
        alert('ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì‚¬ìš©ëŸ‰ ì²´í¬
    if (!canUseService) {
        alert('ë¬´ë£Œ ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\në“±ê¸‰ ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    const serverOk = await checkServer();
    if (!serverOk) {
        alert('ë¡œì»¬ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìœˆë„ìš° ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'ê²€ìƒ‰ ì¤‘...';
    loading.style.display = 'block';
    resultArea.innerHTML = '';
    resultCount.textContent = '';
    
    try {
        const r = await fetch(RANK_API_URL + '/api/product-score?keyword=' + encodeURIComponent(keyword), {
            method: 'GET',
            mode: 'cors',
            headers: {'Accept': 'application/json'}
        });
        const d = await r.json();
        
        if (d.result && d.result.products && d.result.products.length > 0) {
            // ê²€ìƒ‰ ì„±ê³µ ì‹œ ì‚¬ìš©ëŸ‰ ì°¨ê°
            await fetch('/api/product-score/use', { method: 'POST' });
            await checkUsage(); // ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
            
            resultCount.textContent = `(${d.result.products.length}ê°œ)`;
            renderScoreTable(d.result.products);
        } else {
            resultArea.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“­</div><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        }
    } catch(e) {
        console.error(e);
        resultArea.innerHTML = '<div class="empty" style="color:#c00"><div class="empty-icon">âš ï¸</div><p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ê²€ìƒ‰';
        loading.style.display = 'none';
    }
}

function renderScoreTable(products) {
    const resultArea = document.getElementById('resultArea');
    
    let html = `<div class="table-scroll"><table class="score-table">
    <thead><tr>
        <th rowspan="2">ì´ë¯¸ì§€</th>
        <th rowspan="2">ìˆœìœ„</th>
        <th rowspan="2">íŒë§¤ì²˜ìˆ˜</th>
        <th rowspan="2">ê°€ê²©</th>
        <th rowspan="2">ì°œìˆ˜</th>
        <th rowspan="2">ë¦¬ë·°ìˆ˜</th>
        <th rowspan="2">êµ¬ë§¤ê±´ìˆ˜</th>
        <th class="score-red">ì¢…í•©ì ìˆ˜</th>
        <th>ì í•©ë„</th>
        <th class="score-yellow">ì¸ê¸°ë„</th>
        <th>í´ë¦­ì ìˆ˜</th>
        <th>íŒë§¤ì ìˆ˜</th>
        <th>ë¦¬ë·°ì ìˆ˜</th>
        <th>ìµœì‹ ì„±</th>
        <th>ì‹ ë¢°ì„±</th>
        <th>íŒ¨ë„í‹°ë“±ê¸‰</th>
    </tr></thead><tbody>`;
    
    products.forEach(p => {
        html += `<tr class="product-row">
            <td rowspan="2" class="img-cell"><img src="${p.imageUrl || ''}" class="product-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 50 50%22><rect fill=%22%23eee%22 width=%2250%22 height=%2250%22/><text x=%2225%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2210%22>No IMG</text></svg>'"></td>
            <td colspan="15" style="text-align:left;padding:10px">
                <div><strong>ìƒí’ˆëª…:</strong> <span class="product-title" title="${p.productTitle || ''}">${p.productTitle || '-'}</span></div>
                <div style="margin-top:3px"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${p.category || '-'} &nbsp;&nbsp; <strong>íŒë§¤ì²˜ëª…:</strong> ${p.mallName || '-'}</div>
            </td>
        </tr>`;
        
        html += `<tr class="data-row">
            <td>${p.rank || '-'}</td>
            <td>${p.mallCount || 0}</td>
            <td>${formatNumber(p.lowPrice)}</td>
            <td>${formatNumber(p.keepCnt)}</td>
            <td>${formatNumber(p.reviewCount)}</td>
            <td>${formatNumber(p.purchaseCnt)}</td>
            <td class="score-red">${p.relevanceStarScore || 0}</td>
            <td>${p.similarityStarScore || 0}</td>
            <td class="score-yellow">${p.hitStarScore || 0}</td>
            <td>${p.qualityStarScore || 0}</td>
            <td>${p.saleStarScore || 0}</td>
            <td>${p.reviewCountStarScore || 0}</td>
            <td>${p.recentStarScore || 0}</td>
            <td class="${p.reliabilityType === 'GOOD' ? 'score-good' : ''}">${p.reliabilityType || '-'}</td>
            <td class="${p.rankDownScoreType === 'GOOD' ? 'score-good' : (p.rankDownScoreType === 'BAD' ? 'score-bad' : '')}">${p.rankDownScoreType || '-'}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    resultArea.innerHTML = html;
}

document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchProducts();
});

// ì´ˆê¸°í™”
checkUsage();
checkServer();
setInterval(checkServer, 30000);
</script>
{% endblock %}
