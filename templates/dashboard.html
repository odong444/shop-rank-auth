{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block header_title %}ğŸ›ï¸ ë„¤ì´ë²„ ì‡¼í•‘ ìˆœìœ„ì²´í¬{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>â• ìƒí’ˆ ë“±ë¡</h3></div>
    <div class="card-body">
        <!-- ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§í¬ë¡œ MID ì¶”ì¶œ -->
        <div class="form-row" style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px dashed #ddd">
            <input type="text" id="smartstoreUrl" placeholder="ğŸ”— ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§í¬ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: https://smartstore.naver.com/store/products/123456)" style="flex:2">
            <button onclick="extractMid()" id="extractBtn" style="background:#03c75a;color:#fff">MID ì¶”ì¶œ</button>
        </div>
        
        <div class="form-row" style="margin-bottom:15px">
            <input type="text" id="mid" placeholder="MID (ìƒí’ˆë²ˆí˜¸)">
            <input type="text" id="keyword" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ">
            <button onclick="addProduct()" id="addBtn">ë“±ë¡í•˜ê¸°</button>
        </div>
        <div class="form-row">
            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="padding:8px">
            <button onclick="bulkUpload()" id="bulkBtn" style="background:#FF9800;color:#fff">ğŸ“ ëŒ€ëŸ‰ë“±ë¡</button>
            <button onclick="downloadSample()" style="background:#6c757d;color:#fff">ğŸ“¥ ìƒ˜í”ŒíŒŒì¼</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888">* ë“±ë¡ í›„ ìˆœìœ„ê°€ ìë™ìœ¼ë¡œ ì¡°íšŒë©ë‹ˆë‹¤ (ê°œë³„ ë¡œë”©)</p>
    </div>
</div>

<div class="selected-info" id="selectedInfo">
    <span><strong id="selectedCount">0</strong>ê°œ ì„ íƒë¨</span>
    <button class="btn btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
</div>

<div class="card">
    <div class="card-header">
        <h3>ğŸ“‹ ë‚´ ìƒí’ˆ ëª©ë¡ <span id="productCount" style="color:#667eea"></span></h3>
        <div class="btn-group">
            <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-primary" onclick="refreshAll()" id="refreshBtn">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
    <div class="card-body">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ë¡œë”© ì¤‘...</p>
        </div>
        <div class="table-container" id="tableContainer" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-col"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>ìŠ¤í† ì–´ëª…</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>MID</th>
                        <th>í‚¤ì›Œë“œ</th>
                        <th>ìµœì´ˆìˆœìœ„</th>
                        <th>ì´ì „ìˆœìœ„</th>
                        <th>ì˜¤ëŠ˜ìˆœìœ„</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="productBody"></tbody>
            </table>
        </div>
        <div id="empty" class="empty" style="display:none">
            <div class="empty-icon">ğŸ“¦</div>
            <p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
        </div>
    </div>
</div>

<div class="modal" id="historyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“Š ìˆœìœ„ ë³€ë™ ì´ë ¥</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <p id="historyTitle" style="margin-bottom:15px;color:#666"></p>
        <div class="table-container">
            <table>
                <thead><tr><th>ë‚ ì§œ/ì‹œê°„</th><th>ìˆœìœ„</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let selectedIds = new Set();

// ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§í¬ì—ì„œ MID ì¶”ì¶œ
async function extractMid() {
    const url = document.getElementById('smartstoreUrl').value.trim();
    const btn = document.getElementById('extractBtn');
    
    if (!url) {
        alert('ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!url.includes('naver.com')) {
        alert('ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'ì¶”ì¶œ ì¤‘...';
    
    try {
        const r = await fetch('/api/extract-mid?url=' + encodeURIComponent(url));
        const d = await r.json();
        
        if (d.success) {
            document.getElementById('mid').value = d.mid;
            document.getElementById('smartstoreUrl').value = '';
            document.getElementById('keyword').focus();
            alert('âœ… MID ì¶”ì¶œ ì™„ë£Œ: ' + d.mid + '\n\ní‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ë“±ë¡í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        } else {
            alert('âŒ ì¶”ì¶œ ì‹¤íŒ¨: ' + d.error);
        }
    } catch(e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    } finally {
        btn.disabled = false;
        btn.textContent = 'MID ì¶”ì¶œ';
    }
}

// Enter í‚¤ë¡œ MID ì¶”ì¶œ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('smartstoreUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') extractMid();
    });
});

async function loadProducts() {
    try {
        const r = await fetch('/api/products');
        const d = await r.json();
        document.getElementById('loading').style.display = 'none';
        
        if (d.success && d.products.length > 0) {
            products = d.products;
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('productCount').textContent = `(${d.products.length}ê°œ)`;
            selectedIds.clear();
            updateSelectedInfo();
            renderTable();
            checkPendingRanks();
        } else {
            products = [];
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('empty').style.display = 'block';
            document.getElementById('productCount').textContent = '(0ê°œ)';
        }
    } catch(e) {
        document.getElementById('loading').innerHTML = '<p style="color:#c00">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
    }
}

function renderTable() {
    const tbody = document.getElementById('productBody');
    tbody.innerHTML = '';
    
    products.forEach(p => {
        const tr = document.createElement('tr');
        tr.id = 'row-' + p.id;
        const isChecked = selectedIds.has(p.id) ? 'checked' : '';
        
        let todayHtml = p.current_rank === '-' || p.current_rank === 'loading' 
            ? '<div class="spinner-small"></div>' 
            : formatRank(p.current_rank);
            
        if (p.prev_rank && p.prev_rank !== '-' && p.current_rank && p.current_rank !== '-' && p.current_rank !== '300ìœ„ ë°–' && p.current_rank !== 'loading') {
            const prev = parseInt(p.prev_rank), curr = parseInt(p.current_rank);
            if (!isNaN(prev) && !isNaN(curr)) {
                const diff = prev - curr;
                if (diff > 0) todayHtml += ` <span class="rank-down">â–²${diff}</span>`;
                else if (diff < 0) todayHtml += ` <span class="rank-up">â–¼${Math.abs(diff)}</span>`;
            }
        }
        
        let firstHtml = p.first_rank === '-' || p.first_rank === 'loading' 
            ? '<div class="spinner-small"></div>' 
            : formatRank(p.first_rank);
            
        tr.innerHTML = `
            <td class="checkbox-col"><input type="checkbox" ${isChecked} onchange="toggleSelect(${p.id})"></td>
            <td data-label="ìŠ¤í† ì–´ëª…">${p.mall || '-'}</td>
            <td data-label="ìƒí’ˆëª…" style="text-align:left;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.title || ''}">${p.title || '-'}</td>
            <td data-label="MID">${p.mid}</td>
            <td data-label="í‚¤ì›Œë“œ">${p.keyword}</td>
            <td data-label="ìµœì´ˆìˆœìœ„" id="first-${p.id}">${firstHtml}</td>
            <td data-label="ì´ì „ìˆœìœ„">${formatRank(p.prev_rank)}</td>
            <td data-label="ì˜¤ëŠ˜ìˆœìœ„" id="rank-${p.id}">${todayHtml}</td>
            <td>
                <button class="btn btn-info" style="padding:4px 8px;font-size:11px" onclick="showHistory(${p.id},'${p.keyword}')">ì´ë ¥</button>
                <button class="btn btn-danger" style="padding:4px 8px;font-size:11px" onclick="deleteProduct(${p.id})">ì‚­ì œ</button>
            </td>`;
        tbody.appendChild(tr);
    });
    
    document.getElementById('selectAll').checked = selectedIds.size === products.length && products.length > 0;
}

function toggleSelect(id) {
    if (selectedIds.has(id)) selectedIds.delete(id);
    else selectedIds.add(id);
    updateSelectedInfo();
    document.getElementById('selectAll').checked = selectedIds.size === products.length && products.length > 0;
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAll').checked;
    if (checked) products.forEach(p => selectedIds.add(p.id));
    else selectedIds.clear();
    updateSelectedInfo();
    renderTable();
}

function updateSelectedInfo() {
    const info = document.getElementById('selectedInfo');
    const count = document.getElementById('selectedCount');
    count.textContent = selectedIds.size;
    if (selectedIds.size > 0) info.classList.add('show');
    else info.classList.remove('show');
}

async function deleteSelected() {
    if (selectedIds.size === 0) return;
    if (!confirm(`${selectedIds.size}ê°œ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    try {
        const r = await fetch('/api/products/bulk-delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids: Array.from(selectedIds)})
        });
        const d = await r.json();
        if (d.success) {
            alert(`${d.deleted}ê°œ ì‚­ì œ ì™„ë£Œ`);
            selectedIds.clear();
            loadProducts();
        } else alert(d.message);
    } catch(e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    }
}

async function checkPendingRanks() {
    for (const p of products) {
        if (p.current_rank === '-' || p.current_rank === 'loading') {
            await checkSingleRank(p.id);
            await new Promise(r => setTimeout(r, 300));
        }
    }
}

async function checkSingleRank(pid) {
    try {
        const r = await fetch('/api/check-rank/' + pid, {method: 'POST'});
        const d = await r.json();
        
        if (d.success) {
            const p = products.find(x => x.id === pid);
            if (p) {
                p.current_rank = d.rank;
                p.first_rank = d.first_rank;
                p.title = d.title || p.title;
                p.mall = d.mall || p.mall;
            }
            
            const rankCell = document.getElementById('rank-' + pid);
            const firstCell = document.getElementById('first-' + pid);
            if (rankCell) rankCell.innerHTML = formatRank(d.rank);
            if (firstCell) firstCell.innerHTML = formatRank(d.first_rank);
            
            const row = document.getElementById('row-' + pid);
            if (row) {
                row.cells[1].textContent = d.mall || '-';
                row.cells[2].textContent = d.title || '-';
                row.cells[2].title = d.title || '';
            }
        }
    } catch(e) {
        console.error(e);
    }
}

async function addProduct() {
    const mid = document.getElementById('mid').value.trim();
    const kw = document.getElementById('keyword').value.trim();
    const btn = document.getElementById('addBtn');
    
    if (!mid || !kw) {
        alert('MIDì™€ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'ë“±ë¡ ì¤‘...';
    
    try {
        const r = await fetch('/api/products/quick', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mid, keyword: kw})
        });
        const d = await r.json();
        
        if (d.success) {
            document.getElementById('mid').value = '';
            document.getElementById('keyword').value = '';
            await loadProducts();
        } else alert(d.message);
    } catch(e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
    }
}

async function bulkUpload() {
    const fileInput = document.getElementById('excelFile');
    const btn = document.getElementById('bulkBtn');
    
    if (!fileInput.files[0]) {
        alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    btn.disabled = true;
    btn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
    
    try {
        const r = await fetch('/api/bulk-upload', {method: 'POST', body: formData});
        const d = await r.json();
        
        if (d.success) {
            alert(`${d.count}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nìˆœìœ„ ì¡°íšŒê°€ ì‹œì‘ë©ë‹ˆë‹¤.`);
            fileInput.value = '';
            await loadProducts();
        } else alert(d.message);
    } catch(e) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“ ëŒ€ëŸ‰ë“±ë¡';
    }
}

function downloadSample() {
    window.location.href = '/api/sample-excel';
}

async function deleteProduct(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const r = await fetch('/api/products/' + id, {method: 'DELETE'});
        const d = await r.json();
        if (d.success) loadProducts();
        else alert(d.message);
    } catch(e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    }
}

async function refreshAll() {
    if (!confirm('ì „ì²´ ìˆœìœ„ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;
    
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.textContent = 'ì¡°íšŒ ì¤‘...';
    
    try {
        const r = await fetch('/api/refresh', {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            alert(`ìˆœìœ„ ì¡°íšŒ ì™„ë£Œ! (${d.updated}ê°œ ìƒí’ˆ)`);
            loadProducts();
        } else alert(d.message);
    } catch(e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨';
    }
}

async function showHistory(pid, kw) {
    try {
        const r = await fetch('/api/history/' + pid);
        const d = await r.json();
        document.getElementById('historyTitle').textContent = 'í‚¤ì›Œë“œ: ' + kw;
        
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        
        if (d.success && d.history.length > 0) {
            d.history.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${h.checked_at}</td><td>${formatRank(h.rank)}</td>`;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="2">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        document.getElementById('historyModal').style.display = 'flex';
    } catch(e) {
        alert('ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨');
    }
}

function exportExcel() {
    if (products.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    window.location.href = '/api/export';
}

document.getElementById('keyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addProduct();
});

loadProducts();
</script>
{% endblock %}
