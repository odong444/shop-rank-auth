{% extends "base.html" %}

{% block title %}쿠팡 매출조회{% endblock %}

{% block extra_css %}
<style>
.search-box {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.search-box .input {
    flex: 1;
    min-width: 150px;
}
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-size: 0.75rem;
    color: var(--text-gray);
}
.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #EF4444;
}
.status-dot.online {
    background: #10B981;
}
.result-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    background: #fff;
}
.product-header {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}
.product-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    background: var(--bg-gray);
    object-fit: cover;
}
.product-info {
    flex: 1;
    min-width: 0;
}
.product-title {
    font-size: 0.938rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.product-brand {
    font-size: 0.75rem;
    color: var(--text-gray);
    margin-bottom: 4px;
}
.product-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--coupang);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}
.stat-card {
    background: var(--bg-gray);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.stat-card.highlight {
    background: rgba(228, 66, 50, 0.1);
}
.stat-label {
    font-size: 0.688rem;
    color: var(--text-gray);
    margin-bottom: 4px;
}
.stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-dark);
}
.stat-card.highlight .stat-value {
    color: var(--coupang);
}
.hint {
    font-size: 0.688rem;
    color: var(--text-gray);
}
.error-box {
    text-align: center;
    padding: 48px 16px;
    color: #EF4444;
}
.empty-state {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-gray);
}
</style>
{% endblock %}

{% block content %}
<!-- 상태 표시 -->
<div class="status-bar">
    <div class="status-indicator">
        <div id="statusDot" class="status-dot"></div>
        <span id="statusText">연결 확인 중...</span>
    </div>
    <span id="usageInfo"></span>
</div>

<!-- 업그레이드 알림 -->
<div id="upgradeNotice" class="alert alert-warning hidden">
    오늘 무료 사용 횟수를 모두 사용했습니다. (1회/일)
</div>

<!-- 검색 -->
<div class="card">
    <div class="search-box">
        <input type="text" id="productId" placeholder="쿠팡 상품 ID 또는 URL 입력" class="input">
        <button onclick="searchProduct()" id="searchBtn" class="btn btn-primary">조회</button>
    </div>
    <p class="hint">* 상품 ID 또는 쿠팡 상품 URL을 입력하세요</p>
</div>

<!-- 로딩 -->
<div id="loading" class="flex flex-col items-center py-8 hidden">
    <div class="spinner"></div>
    <p class="mt-4 text-sm text-gray">조회 중...</p>
</div>

<!-- 결과 영역 -->
<div id="resultArea" class="hidden">
    <div class="result-card">
        <div class="product-header">
            <img id="productImage" class="product-image" src="" alt="">
            <div class="product-info">
                <div id="productTitle" class="product-title"></div>
                <div id="productBrand" class="product-brand"></div>
                <div id="productPrice" class="product-price"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">28일 판매량</div>
                <div class="stat-value" id="sales28d">0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">28일 조회수</div>
                <div class="stat-value" id="pv28d">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">평점</div>
                <div class="stat-value" id="rating">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">리뷰수</div>
                <div class="stat-value" id="ratingCount">0</div>
            </div>
        </div>
    </div>
</div>

<!-- 에러 영역 -->
<div id="errorArea" class="hidden">
    <div class="card error-box">
        <p id="errorMsg">오류가 발생했습니다.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let canUseService = true;

async function checkApiStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');

    try {
        const r = await fetch('/api/coupang/health');
        const d = await r.json();

        if (d.success && d.status === 'online') {
            dot.classList.add('online');
            text.textContent = '서버 연결됨';
        } else if (d.status === 'not_configured') {
            text.textContent = 'API 미설정';
        } else {
            text.textContent = '서버 오프라인';
        }
    } catch(e) {
        text.textContent = '연결 확인 실패';
    }
}

async function checkUsage() {
    try {
        const r = await fetch('/api/coupang/sales/check-usage');
        const d = await r.json();
        if (d.success) updateUsageDisplay(d);
    } catch(e) {
        console.error('사용량 체크 실패:', e);
    }
}

function updateUsageDisplay(data) {
    const usageInfo = document.getElementById('usageInfo');
    const upgradeNotice = document.getElementById('upgradeNotice');
    const searchBtn = document.getElementById('searchBtn');

    if (data.limit === -1) {
        usageInfo.textContent = '무제한';
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else if (data.canUse) {
        usageInfo.textContent = `남은 횟수: ${data.remaining}/${data.limit}`;
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else {
        usageInfo.textContent = `사용 완료 (${data.used}/${data.limit})`;
        canUseService = false;
        upgradeNotice.classList.remove('hidden');
        searchBtn.disabled = true;
    }
}

function extractProductId(input) {
    // URL에서 productId 추출
    const match = input.match(/products\/(\d+)/);
    if (match) return match[1];

    // 숫자만 입력된 경우
    if (/^\d+$/.test(input.trim())) {
        return input.trim();
    }

    return null;
}

async function searchProduct() {
    const input = document.getElementById('productId').value.trim();
    const btn = document.getElementById('searchBtn');

    if (!input) {
        alert('상품 ID 또는 URL을 입력해주세요.');
        return;
    }

    const productId = extractProductId(input);
    if (!productId) {
        alert('올바른 상품 ID 또는 URL을 입력해주세요.');
        return;
    }

    if (!canUseService) {
        alert('오늘 사용 횟수를 모두 사용했습니다.');
        return;
    }

    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('errorArea').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    btn.disabled = true;
    btn.textContent = '조회중...';

    try {
        const r = await fetch('/api/coupang/product/' + productId);
        const d = await r.json();

        document.getElementById('loading').classList.add('hidden');

        if (d.success) {
            await checkUsage();
            displayResult(d.data || d);
        } else {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMsg').textContent = d.message || '조회에 실패했습니다.';
        }
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('errorArea').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = '서버 연결 실패';
    } finally {
        btn.disabled = !canUseService;
        btn.textContent = '조회';
    }
}

function displayResult(data) {
    document.getElementById('resultArea').classList.remove('hidden');

    // 이미지 (기본 이미지 사용)
    const imgEl = document.getElementById('productImage');
    if (data.imageUrl) {
        imgEl.src = data.imageUrl;
    } else {
        imgEl.style.display = 'none';
    }

    document.getElementById('productTitle').textContent = data.productName || data.itemName || '-';
    document.getElementById('productBrand').textContent = data.brandName || '-';
    document.getElementById('productPrice').textContent = formatNumber(data.salePrice || 0) + '원';

    document.getElementById('sales28d').textContent = formatNumber(data.salesLast28d || 0) + '개';
    document.getElementById('pv28d').textContent = formatNumber(data.pvLast28Day || 0);
    document.getElementById('rating').textContent = data.rating ? data.rating.toFixed(1) : '-';
    document.getElementById('ratingCount').textContent = formatNumber(data.ratingCount || 0) + '개';
}

document.getElementById('productId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchProduct();
});

checkApiStatus();
checkUsage();
</script>
{% endblock %}
