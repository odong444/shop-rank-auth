<!DOCTYPE html>
<html lang="ko" data-theme="shoprank">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
</head>
<body class="bg-base-200 min-h-screen p-4 md:p-6">
<div class="max-w-7xl mx-auto">
    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="flex flex-wrap gap-2 justify-center mb-6">
        <a href="/naver-shop" class="btn btn-primary">â† ë©”ì¸ìœ¼ë¡œ</a>
        <a href="/admin/logout" class="btn btn-error">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <h1 class="text-2xl font-bold text-center mb-6">ğŸ” ê´€ë¦¬ì í˜ì´ì§€</h1>

    <!-- í†µê³„ -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

    <!-- ë“±ê¸‰ ì•ˆë‚´ -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body py-4">
            <h4 class="font-bold mb-2">ğŸ“‹ íšŒì› ë“±ê¸‰ ì•ˆë‚´</h4>
            <ul class="text-sm space-y-1">
                <li><span class="badge badge-ghost">ì¼ë°˜</span> - ìˆœìœ„ì¡°íšŒ ë¬´ì œí•œ / ìƒí’ˆì§€ìˆ˜Â·ë§¤ì¶œì¡°íšŒ: ë§ˆì¼€íŒ…ë™ì˜ 30íšŒ, ë¯¸ë™ì˜ 3íšŒ</li>
                <li><span class="badge badge-success">ê³ ê°</span> - ì „ì²´ ê¸°ëŠ¥ ë¬´ì œí•œ</li>
                <li><span class="badge badge-info">ê´€ë¦¬ì</span> - ì „ì²´ ê¸°ëŠ¥ ë¬´ì œí•œ + ê´€ë¦¬ ê¸°ëŠ¥</li>
            </ul>
        </div>
    </div>

    <!-- íƒ­ -->
    <div role="tablist" class="tabs tabs-boxed mb-6 flex-wrap">
        <a role="tab" class="tab tab-active" id="tab-btn-users" onclick="showTab('users')">ğŸ‘¥ íšŒì›</a>
        <a role="tab" class="tab" id="tab-btn-products" onclick="showTab('products')">ğŸ“¦ ìƒí’ˆ</a>
        <a role="tab" class="tab" id="tab-btn-logs" onclick="showTab('logs')">ğŸ“Š ë¡œê·¸</a>
        <a role="tab" class="tab" id="tab-btn-notices" onclick="showTab('notices')">ğŸ“¢ ê³µì§€</a>
    </div>

    <!-- íšŒì› ê´€ë¦¬ íƒ­ -->
    <div id="tab-users" class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <!-- ì „ì²´ ì´ˆê¸°í™” ì„¹ì…˜ -->
            <div class="alert alert-warning mb-4">
                <div class="flex-1">
                    <span>âš ï¸ ì „ì²´ ì‚¬ìš©ìì˜ ì‚¬ìš©ëŸ‰(ìƒí’ˆì§€ìˆ˜/ë§¤ì¶œì¡°íšŒ)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</span>
                </div>
                <button class="btn btn-info btn-sm" onclick="resetAllUsage()">ğŸ”„ ì „ì²´ ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”</button>
            </div>

            <button class="btn btn-primary mb-4" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì•„ì´ë””</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ìƒí’ˆìˆ˜</th>
                            <th>ë“±ê¸‰</th>
                            <th>ì‚¬ìš©ëŸ‰</th>
                            <th>ìŠ¹ì¸</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ ìƒí’ˆ íƒ­ -->
    <div id="tab-products" class="card bg-base-100 shadow-lg hidden">
        <div class="card-body">
            <div class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="searchKeyword" placeholder="í‚¤ì›Œë“œ ë˜ëŠ” ìŠ¤í† ì–´ëª… ê²€ìƒ‰" class="input input-bordered flex-1 min-w-[200px]">
                <select id="filterUser" class="select select-bordered">
                    <option value="">ì „ì²´ ì‚¬ìš©ì</option>
                </select>
                <button class="btn btn-success" onclick="loadAllProducts()">ê²€ìƒ‰</button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì‚¬ìš©ì</th>
                            <th>ìŠ¤í† ì–´ëª…</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>MID</th>
                            <th>í‚¤ì›Œë“œ</th>
                            <th>í˜„ì¬ìˆœìœ„</th>
                            <th>ë“±ë¡ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="productTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ íƒ­ -->
    <div id="tab-logs" class="card bg-base-100 shadow-lg hidden">
        <div class="card-body">
            <!-- ì˜¤ëŠ˜ í†µê³„ -->
            <div id="logStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>

            <div class="flex flex-wrap gap-2 mb-4">
                <select id="logAction" class="select select-bordered select-sm">
                    <option value="">ì „ì²´ í™œë™</option>
                    <option value="login">ë¡œê·¸ì¸</option>
                    <option value="product_score">ìƒí’ˆì§€ìˆ˜</option>
                    <option value="brand_sales">ë§¤ì¶œì¡°íšŒ</option>
                    <option value="coupang_search">ì¿ íŒ¡ìˆœìœ„</option>
                    <option value="coupang_sales">ì¿ íŒ¡ë§¤ì¶œ</option>
                </select>
                <input type="text" id="logUserId" placeholder="ì‚¬ìš©ì ID" class="input input-bordered input-sm w-32">
                <button class="btn btn-primary btn-sm" onclick="loadLogs()">ê²€ìƒ‰</button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì‹œê°„</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>í™œë™</th>
                            <th>ìƒì„¸</th>
                            <th>IP</th>
                        </tr>
                    </thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ê³µì§€ì‚¬í•­ íƒ­ -->
    <div id="tab-notices" class="card bg-base-100 shadow-lg hidden">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                <button class="btn btn-success btn-sm" onclick="showNoticeModal()">+ ìƒˆ ê³µì§€</button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì œëª©</th>
                            <th>íŒì—…</th>
                            <th>ìƒíƒœ</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="noticeTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ê³µì§€ì‚¬í•­ ëª¨ë‹¬ -->
<dialog id="noticeModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4" id="noticeModalTitle">ìƒˆ ê³µì§€ì‚¬í•­</h3>
        <input type="hidden" id="noticeId">
        <div class="form-control mb-3">
            <label class="label"><span class="label-text">ì œëª©</span></label>
            <input type="text" id="noticeTitle" class="input input-bordered" placeholder="ê³µì§€ ì œëª©">
        </div>
        <div class="form-control mb-3">
            <label class="label"><span class="label-text">ë‚´ìš©</span></label>
            <textarea id="noticeContent" class="textarea textarea-bordered h-32" placeholder="ê³µì§€ ë‚´ìš©"></textarea>
        </div>
        <div class="form-control mb-4">
            <label class="label cursor-pointer justify-start gap-3">
                <input type="checkbox" id="noticePopup" class="checkbox checkbox-primary">
                <span class="label-text">íŒì—…ìœ¼ë¡œ í‘œì‹œ</span>
            </label>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveNotice()">ì €ì¥</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
const FREE_LIMIT_MARKETING = 30;
const FREE_LIMIT_DEFAULT = 3;
const COUPANG_SALES_LIMIT = 1;

const TABS = ['users', 'products', 'logs', 'notices'];

function showTab(tab) {
    // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼
    TABS.forEach(t => {
        document.getElementById('tab-btn-' + t).classList.remove('tab-active');
        document.getElementById('tab-' + t).classList.add('hidden');
    });
    document.getElementById('tab-btn-' + tab).classList.add('tab-active');
    document.getElementById('tab-' + tab).classList.remove('hidden');

    if (tab === 'products') loadAllProducts();
    if (tab === 'logs') { loadLogStats(); loadLogs(); }
    if (tab === 'notices') loadNotices();
}

function getRoleBadge(role) {
    const badges = {
        admin: '<span class="badge badge-info">ê´€ë¦¬ì</span>',
        customer: '<span class="badge badge-success">ê³ ê°</span>',
        normal: '<span class="badge badge-ghost">ì¼ë°˜</span>'
    };
    return badges[role] || badges.normal;
}

function getRoleSelect(userId, currentRole) {
    return `
        <select class="select select-bordered select-xs" onchange="changeRole('${userId}', this.value)">
            <option value="normal" ${currentRole === 'normal' ? 'selected' : ''}>ì¼ë°˜</option>
            <option value="customer" ${currentRole === 'customer' ? 'selected' : ''}>ê³ ê°</option>
            <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
        </select>
    `;
}

function getUsageDisplay(role, productScoreUsed, brandSalesUsed, marketingAgreed, coupangSalesUsed = 0) {
    if (role === 'customer' || role === 'admin') {
        return '<span class="badge badge-success badge-sm">ë¬´ì œí•œ</span>';
    }

    const limit = marketingAgreed ? FREE_LIMIT_MARKETING : FREE_LIMIT_DEFAULT;
    const psClass = productScoreUsed >= limit ? 'text-error' : 'text-success';
    const bsClass = brandSalesUsed >= limit ? 'text-error' : 'text-success';
    const csClass = coupangSalesUsed >= COUPANG_SALES_LIMIT ? 'text-error' : 'text-success';
    const marketingBadge = marketingAgreed
        ? '<span class="badge badge-success badge-xs">ë§ˆì¼€íŒ…O</span>'
        : '<span class="badge badge-ghost badge-xs">ë§ˆì¼€íŒ…X</span>';

    return `
        <div class="text-xs space-y-1">
            <div>${marketingBadge}</div>
            <div>ìƒí’ˆì§€ìˆ˜: <span class="${psClass} font-bold">${productScoreUsed}/${limit}</span></div>
            <div>ë§¤ì¶œì¡°íšŒ: <span class="${bsClass} font-bold">${brandSalesUsed}/${limit}</span></div>
            <div>ì¿ íŒ¡ë§¤ì¶œ: <span class="${csClass} font-bold">${coupangSalesUsed}/${COUPANG_SALES_LIMIT}</span></div>
        </div>
    `;
}

async function loadStats() {
    try {
        const r = await fetch('/admin/stats');
        const d = await r.json();
        if (d.success) {
            document.getElementById('stats').innerHTML = `
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì „ì²´ íšŒì›</div>
                    <div class="stat-value text-primary">${d.totalUsers}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ìŠ¹ì¸ íšŒì›</div>
                    <div class="stat-value text-success">${d.approvedUsers}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì „ì²´ ìƒí’ˆ</div>
                    <div class="stat-value text-secondary">${d.totalProducts}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì˜¤ëŠ˜ ë“±ë¡</div>
                    <div class="stat-value text-info">${d.todayProducts}</div>
                </div>`;
        }
    } catch(e) {}
}

async function loadUsers() {
    try {
        const r = await fetch('/admin/users');
        const d = await r.json();
        if (d.success) {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';
            const select = document.getElementById('filterUser');
            select.innerHTML = '<option value="">ì „ì²´ ì‚¬ìš©ì</option>';

            d.users.forEach(u => {
                select.innerHTML += `<option value="${u.userId}">${u.userId} (${u.name})</option>`;
                const tr = document.createElement('tr');
                const role = u.role || 'normal';
                tr.innerHTML = `
                    <td>${u.userId}</td>
                    <td>${u.name}</td>
                    <td>${u.phone}</td>
                    <td>${u.regDate}</td>
                    <td>${u.productCount || 0}ê°œ</td>
                    <td>${getRoleSelect(u.userId, role)}</td>
                    <td>${getUsageDisplay(role, u.productScoreUsed || 0, u.brandSalesUsed || 0, u.marketingAgreed, u.coupangSalesUsed || 0)}</td>
                    <td>
                        ${u.approved === 'Y'
                            ? '<span class="badge badge-success badge-sm">ìŠ¹ì¸ë¨</span>'
                            : '<span class="badge badge-error badge-sm">ëŒ€ê¸°ì¤‘</span>'}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                            ${u.approved === 'Y'
                                ? `<button class="btn btn-warning btn-xs" onclick="setApproval('${u.userId}','N')">ì·¨ì†Œ</button>`
                                : `<button class="btn btn-success btn-xs" onclick="setApproval('${u.userId}','Y')">ìŠ¹ì¸</button>`}
                            <button class="btn btn-ghost btn-xs" onclick="resetUsage('${u.userId}')" title="ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
                            <button class="btn btn-error btn-xs" onclick="deleteUser('${u.userId}')">ì‚­ì œ</button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function loadAllProducts() {
    try {
        const kw = document.getElementById('searchKeyword').value;
        const user = document.getElementById('filterUser').value;
        const r = await fetch(`/admin/all-products?keyword=${encodeURIComponent(kw)}&user=${encodeURIComponent(user)}`);
        const d = await r.json();

        if (d.success) {
            const tbody = document.getElementById('productTable');
            tbody.innerHTML = '';
            d.products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.userId}</td>
                    <td>${p.mall || '-'}</td>
                    <td class="max-w-[200px] truncate" title="${p.title || ''}">${p.title || '-'}</td>
                    <td>${p.mid}</td>
                    <td>${p.keyword}</td>
                    <td>${p.currentRank || '-'}</td>
                    <td>${p.createdAt || '-'}</td>`;
                tbody.appendChild(tr);
            });
            if (d.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-base-content/60">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function changeRole(userId, newRole) {
    try {
        const r = await fetch('/admin/role', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId, role: newRole})
        });
        const d = await r.json();
        if (d.success) {
            loadUsers();
        } else {
            alert(d.message || 'ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
            loadUsers();
        }
    } catch(e) {
        alert('ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
        loadUsers();
    }
}

async function resetUsage(userId) {
    if (!confirm(`${userId} íšŒì›ì˜ ì‚¬ìš©ëŸ‰ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const r = await fetch('/admin/reset-usage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        });
        const d = await r.json();
        if (d.success) {
            alert('ì´ˆê¸°í™” ì™„ë£Œ');
            loadUsers();
        } else {
            alert(d.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨');
    }
}

async function resetAllUsage() {
    if (!confirm('âš ï¸ ì „ì²´ ì‚¬ìš©ìì˜ ì‚¬ìš©ëŸ‰ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

    try {
        const r = await fetch('/admin/reset-all-usage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const d = await r.json();
        if (d.success) {
            alert('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
            loadUsers();
        } else {
            alert(d.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨');
    }
}

async function setApproval(id, ap) {
    const r = await fetch('/admin/approve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id, approved: ap})
    });
    const d = await r.json();
    if (d.success) loadUsers();
    else alert(d.message);
}

async function deleteUser(id) {
    if (!confirm(id + ' íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const r = await fetch('/admin/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id})
    });
    const d = await r.json();
    if (d.success) {
        loadUsers();
        loadStats();
    } else alert(d.message);
}

document.getElementById('searchKeyword').addEventListener('keypress', e => {
    if (e.key === 'Enter') loadAllProducts();
});

// ===== ë¡œê·¸ ê´€ë¦¬ =====

async function loadLogStats() {
    try {
        const r = await fetch('/admin/logs/stats');
        const d = await r.json();
        if (d.success) {
            let actionsHtml = '';
            d.todayActions.slice(0, 3).forEach(a => {
                actionsHtml += `<div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">${getActionName(a.action)}</div>
                    <div class="stat-value text-sm">${a.count}íšŒ</div>
                </div>`;
            });
            document.getElementById('logStats').innerHTML = `
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì˜¤ëŠ˜ ë°©ë¬¸ì</div>
                    <div class="stat-value text-primary">${d.todayLogins}</div>
                </div>
                ${actionsHtml}`;
        }
    } catch(e) {}
}

function getActionName(action) {
    const names = {
        'login': 'ë¡œê·¸ì¸',
        'product_score': 'ìƒí’ˆì§€ìˆ˜',
        'brand_sales': 'ë§¤ì¶œì¡°íšŒ',
        'coupang_search': 'ì¿ íŒ¡ìˆœìœ„',
        'coupang_sales': 'ì¿ íŒ¡ë§¤ì¶œ'
    };
    return names[action] || action;
}

async function loadLogs() {
    try {
        const action = document.getElementById('logAction').value;
        const userId = document.getElementById('logUserId').value;
        const r = await fetch(`/admin/logs?action=${action}&user_id=${userId}&limit=100`);
        const d = await r.json();

        if (d.success) {
            const tbody = document.getElementById('logTable');
            tbody.innerHTML = '';

            d.logs.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-xs">${l.createdAt}</td>
                    <td>${l.userName} (${l.userId})</td>
                    <td><span class="badge badge-ghost badge-sm">${getActionName(l.action)}</span></td>
                    <td class="text-xs">${l.detail || '-'}</td>
                    <td class="text-xs">${l.ipAddress || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            if (d.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-base-content/60">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    } catch(e) {
        alert('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨');
    }
}

// ===== ê³µì§€ì‚¬í•­ ê´€ë¦¬ =====

async function loadNotices() {
    try {
        const r = await fetch('/admin/notices');
        const d = await r.json();

        if (d.success) {
            const tbody = document.getElementById('noticeTable');
            tbody.innerHTML = '';

            d.notices.forEach(n => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${n.title}</td>
                    <td>${n.isPopup ? '<span class="badge badge-primary badge-sm">íŒì—…</span>' : '-'}</td>
                    <td>${n.isActive ? '<span class="badge badge-success badge-sm">í™œì„±</span>' : '<span class="badge badge-ghost badge-sm">ë¹„í™œì„±</span>'}</td>
                    <td>${n.createdAt}</td>
                    <td>
                        <button class="btn btn-ghost btn-xs" onclick="editNotice(${n.id})">ìˆ˜ì •</button>
                        <button class="btn btn-error btn-xs" onclick="deleteNoticeConfirm(${n.id})">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (d.notices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-base-content/60">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    } catch(e) {
        alert('ê³µì§€ ë¡œë“œ ì‹¤íŒ¨');
    }
}

let noticesCache = [];

function showNoticeModal(notice = null) {
    document.getElementById('noticeId').value = notice ? notice.id : '';
    document.getElementById('noticeTitle').value = notice ? notice.title : '';
    document.getElementById('noticeContent').value = notice ? notice.content : '';
    document.getElementById('noticePopup').checked = notice ? notice.isPopup : false;
    document.getElementById('noticeModalTitle').textContent = notice ? 'ê³µì§€ì‚¬í•­ ìˆ˜ì •' : 'ìƒˆ ê³µì§€ì‚¬í•­';
    document.getElementById('noticeModal').showModal();
}

function closeNoticeModal() {
    document.getElementById('noticeModal').close();
}

async function editNotice(id) {
    try {
        const r = await fetch('/admin/notices');
        const d = await r.json();
        if (d.success) {
            const notice = d.notices.find(n => n.id === id);
            if (notice) showNoticeModal(notice);
        }
    } catch(e) {}
}

async function saveNotice() {
    const id = document.getElementById('noticeId').value;
    const title = document.getElementById('noticeTitle').value.trim();
    const content = document.getElementById('noticeContent').value.trim();
    const isPopup = document.getElementById('noticePopup').checked;

    if (!title) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        let r;
        if (id) {
            r = await fetch(`/admin/notices/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, content, isPopup, isActive: true})
            });
        } else {
            r = await fetch('/admin/notices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, content, isPopup})
            });
        }
        const d = await r.json();
        if (d.success) {
            closeNoticeModal();
            loadNotices();
        } else {
            alert(d.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì €ì¥ ì‹¤íŒ¨');
    }
}

async function deleteNoticeConfirm(id) {
    if (!confirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const r = await fetch(`/admin/notices/${id}`, {method: 'DELETE'});
        const d = await r.json();
        if (d.success) {
            loadNotices();
        } else {
            alert(d.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì‚­ì œ ì‹¤íŒ¨');
    }
}

loadStats();
loadUsers();
</script>
</body>
</html>
