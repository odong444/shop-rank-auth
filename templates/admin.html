<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        h1 { text-align: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #4a90d9; color: #fff; }
        tr:hover { background: #f9f9f9; }
        .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-approve { background: #28a745; color: #fff; }
        .btn-reject { background: #ffc107; }
        .btn-delete { background: #dc3545; color: #fff; }
        .refresh-btn { display: block; margin: 20px auto; padding: 10px 30px; background: #4a90d9; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .top-btns { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .top-btns a, .top-btns button { padding: 8px 16px; border-radius: 5px; text-decoration: none; font-size: 14px; border: none; cursor: pointer; }
        .back-btn { background: #667eea; color: #fff; }
        .logout-btn { background: #dc3545; color: #fff; }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 14px; color: #666; }
        .tab.active { color: #4a90d9; border-bottom: 2px solid #4a90d9; margin-bottom: -2px; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-box { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-box input, .search-box select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; }
        .search-box input { flex: 1; min-width: 200px; }
        .product-title { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { background: #f8f9fa; padding: 15px 25px; border-radius: 8px; text-align: center; }
        .stat-box .num { font-size: 24px; font-weight: bold; color: #4a90d9; }
        .stat-box .label { font-size: 12px; color: #666; }
        
        /* ë“±ê¸‰ ë°°ì§€ */
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .role-admin { background: #cce5ff; color: #004085; }
        .role-customer { background: #d4edda; color: #155724; }
        .role-normal { background: #e9ecef; color: #495057; }
        
        /* ë“±ê¸‰ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .role-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        .role-select:focus { outline: none; border-color: #4a90d9; }
        
        /* ë“±ê¸‰ ì•ˆë‚´ */
        .role-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .role-info h4 { margin: 0 0 10px 0; color: #333; }
        .role-info ul { margin: 0; padding-left: 20px; }
        .role-info li { margin: 5px 0; color: #666; }
    </style>
</head>
<body>
<div class="container">
    <div class="top-btns">
        <a href="/naver-shop" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>
        <a href="/admin/logout" class="logout-btn">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <h1>ğŸ” ê´€ë¦¬ì í˜ì´ì§€</h1>
    <div class="stats" id="stats"></div>
    
    <div class="role-info">
        <h4>ğŸ“‹ íšŒì› ë“±ê¸‰ ì•ˆë‚´</h4>
        <ul>
            <li><span class="role-badge role-normal">ì¼ë°˜</span> - ê¸°ë³¸ ê°€ì…ì (ì¼ 5íšŒ ì‚¬ìš©)</li>
            <li><span class="role-badge role-customer">ê³ ê°</span> - ìœ ë£Œ ê³ ê° (ì¼ 20íšŒ ì‚¬ìš©)</li>
            <li><span class="role-badge role-admin">ê´€ë¦¬ì</span> - ê´€ë¦¬ì (ë¬´ì œí•œ ì‚¬ìš©)</li>
        </ul>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">ğŸ‘¥ íšŒì› ê´€ë¦¬</button>
        <button class="tab" onclick="showTab('products')">ğŸ“¦ ì „ì²´ ìƒí’ˆ</button>
    </div>
    <div class="tab-content active" id="tab-users">
        <button class="refresh-btn" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button>
        <table>
            <thead>
                <tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê°€ì…ì¼</th><th>ìƒí’ˆìˆ˜</th><th>ë“±ê¸‰</th><th>ìŠ¹ì¸</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-products">
        <div class="search-box">
            <input type="text" id="searchKeyword" placeholder="í‚¤ì›Œë“œ ë˜ëŠ” ìŠ¤í† ì–´ëª… ê²€ìƒ‰">
            <select id="filterUser"><option value="">ì „ì²´ ì‚¬ìš©ì</option></select>
            <button class="btn btn-approve" onclick="loadAllProducts()">ê²€ìƒ‰</button>
        </div>
        <table>
            <thead>
                <tr><th>ì‚¬ìš©ì</th><th>ìŠ¤í† ì–´ëª…</th><th>ìƒí’ˆëª…</th><th>MID</th><th>í‚¤ì›Œë“œ</th><th>í˜„ì¬ìˆœìœ„</th><th>ë“±ë¡ì¼</th></tr>
            </thead>
            <tbody id="productTable"></tbody>
        </table>
    </div>
</div>
<script>
function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab-content#tab-${tab}`).classList.add('active');
    event.target.classList.add('active');
    if (tab === 'products') loadAllProducts();
}

function getRoleBadge(role) {
    const labels = { admin: 'ê´€ë¦¬ì', customer: 'ê³ ê°', normal: 'ì¼ë°˜' };
    return `<span class="role-badge role-${role}">${labels[role] || 'ì¼ë°˜'}</span>`;
}

function getRoleSelect(userId, currentRole) {
    return `
        <select class="role-select" onchange="changeRole('${userId}', this.value)">
            <option value="normal" ${currentRole === 'normal' ? 'selected' : ''}>ì¼ë°˜</option>
            <option value="customer" ${currentRole === 'customer' ? 'selected' : ''}>ê³ ê°</option>
            <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
        </select>
    `;
}

async function loadStats() {
    try {
        const r = await fetch('/admin/stats');
        const d = await r.json();
        if (d.success) {
            document.getElementById('stats').innerHTML = `
                <div class="stat-box"><div class="num">${d.totalUsers}</div><div class="label">ì „ì²´ íšŒì›</div></div>
                <div class="stat-box"><div class="num">${d.approvedUsers}</div><div class="label">ìŠ¹ì¸ íšŒì›</div></div>
                <div class="stat-box"><div class="num">${d.totalProducts}</div><div class="label">ì „ì²´ ìƒí’ˆ</div></div>
                <div class="stat-box"><div class="num">${d.todayProducts}</div><div class="label">ì˜¤ëŠ˜ ë“±ë¡</div></div>`;
        }
    } catch(e) {}
}

async function loadUsers() {
    try {
        const r = await fetch('/admin/users');
        const d = await r.json();
        if (d.success) {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';
            const select = document.getElementById('filterUser');
            select.innerHTML = '<option value="">ì „ì²´ ì‚¬ìš©ì</option>';
            
            d.users.forEach(u => {
                select.innerHTML += `<option value="${u.userId}">${u.userId} (${u.name})</option>`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.userId}</td>
                    <td>${u.name}</td>
                    <td>${u.phone}</td>
                    <td>${u.regDate}</td>
                    <td>${u.productCount || 0}ê°œ</td>
                    <td>${getRoleSelect(u.userId, u.role || 'normal')}</td>
                    <td style="color:${u.approved === 'Y' ? '#28a745' : '#dc3545'};font-weight:bold">${u.approved === 'Y' ? 'ìŠ¹ì¸ë¨' : 'ëŒ€ê¸°ì¤‘'}</td>
                    <td>
                        ${u.approved === 'Y' 
                            ? `<button class="btn btn-reject" onclick="setApproval('${u.userId}','N')">ìŠ¹ì¸ì·¨ì†Œ</button>` 
                            : `<button class="btn btn-approve" onclick="setApproval('${u.userId}','Y')">ìŠ¹ì¸</button>`}
                        <button class="btn btn-delete" onclick="deleteUser('${u.userId}')">ì‚­ì œ</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function loadAllProducts() {
    try {
        const kw = document.getElementById('searchKeyword').value;
        const user = document.getElementById('filterUser').value;
        const r = await fetch(`/admin/all-products?keyword=${encodeURIComponent(kw)}&user=${encodeURIComponent(user)}`);
        const d = await r.json();
        
        if (d.success) {
            const tbody = document.getElementById('productTable');
            tbody.innerHTML = '';
            d.products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.userId}</td>
                    <td>${p.mall || '-'}</td>
                    <td class="product-title" title="${p.title || ''}">${p.title || '-'}</td>
                    <td>${p.mid}</td>
                    <td>${p.keyword}</td>
                    <td>${p.currentRank || '-'}</td>
                    <td>${p.createdAt || '-'}</td>`;
                tbody.appendChild(tr);
            });
            if (d.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function changeRole(userId, newRole) {
    try {
        const r = await fetch('/admin/role', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId, role: newRole})
        });
        const d = await r.json();
        if (d.success) {
            // ì„±ê³µ ì‹œ ê°„ë‹¨í•œ í”¼ë“œë°±
            console.log(`${userId} ë“±ê¸‰ ë³€ê²½: ${newRole}`);
        } else {
            alert(d.message || 'ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
            loadUsers(); // ì‹¤íŒ¨ ì‹œ ì›ë³µ
        }
    } catch(e) {
        alert('ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
        loadUsers();
    }
}

async function setApproval(id, ap) {
    const r = await fetch('/admin/approve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id, approved: ap})
    });
    const d = await r.json();
    if (d.success) loadUsers();
    else alert(d.message);
}

async function deleteUser(id) {
    if (!confirm(id + ' íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const r = await fetch('/admin/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id})
    });
    const d = await r.json();
    if (d.success) {
        loadUsers();
        loadStats();
    } else alert(d.message);
}

document.getElementById('searchKeyword').addEventListener('keypress', e => {
    if (e.key === 'Enter') loadAllProducts();
});

loadStats();
loadUsers();
</script>
</body>
</html>
