<!DOCTYPE html>
<html lang="ko" data-theme="shoprank">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
</head>
<body class="bg-base-200 min-h-screen p-4 md:p-6">
<div class="max-w-7xl mx-auto">
    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="flex flex-wrap gap-2 justify-center mb-6">
        <a href="/naver-shop" class="btn btn-primary">â† ë©”ì¸ìœ¼ë¡œ</a>
        <a href="/admin/logout" class="btn btn-error">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <h1 class="text-2xl font-bold text-center mb-6">ğŸ” ê´€ë¦¬ì í˜ì´ì§€</h1>

    <!-- í†µê³„ -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

    <!-- ë“±ê¸‰ ì•ˆë‚´ -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body py-4">
            <h4 class="font-bold mb-2">ğŸ“‹ íšŒì› ë“±ê¸‰ ì•ˆë‚´</h4>
            <ul class="text-sm space-y-1">
                <li><span class="badge badge-ghost">ì¼ë°˜</span> - ìˆœìœ„ì¡°íšŒ ë¬´ì œí•œ / ìƒí’ˆì§€ìˆ˜ 30íšŒ / ë§¤ì¶œì¡°íšŒ 30íšŒ</li>
                <li><span class="badge badge-success">ê³ ê°</span> - ì „ì²´ ê¸°ëŠ¥ ë¬´ì œí•œ</li>
                <li><span class="badge badge-info">ê´€ë¦¬ì</span> - ì „ì²´ ê¸°ëŠ¥ ë¬´ì œí•œ + ê´€ë¦¬ ê¸°ëŠ¥</li>
            </ul>
        </div>
    </div>

    <!-- íƒ­ -->
    <div role="tablist" class="tabs tabs-boxed mb-6">
        <a role="tab" class="tab tab-active" id="tab-btn-users" onclick="showTab('users')">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
        <a role="tab" class="tab" id="tab-btn-products" onclick="showTab('products')">ğŸ“¦ ì „ì²´ ìƒí’ˆ</a>
        <a role="tab" class="tab" id="tab-btn-withdrawals" onclick="showTab('withdrawals')">
            ğŸ’° ì¶œê¸ˆ ê´€ë¦¬
            <span id="withdrawalBadge" class="badge badge-error badge-sm ml-1 hidden">0</span>
        </a>
    </div>

    <!-- íšŒì› ê´€ë¦¬ íƒ­ -->
    <div id="tab-users" class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <!-- ì „ì²´ ì´ˆê¸°í™” ì„¹ì…˜ -->
            <div class="alert alert-warning mb-4">
                <div class="flex-1">
                    <span>âš ï¸ ì „ì²´ ì‚¬ìš©ìì˜ ì‚¬ìš©ëŸ‰(ìƒí’ˆì§€ìˆ˜/ë§¤ì¶œì¡°íšŒ)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</span>
                </div>
                <button class="btn btn-info btn-sm" onclick="resetAllUsage()">ğŸ”„ ì „ì²´ ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”</button>
            </div>

            <button class="btn btn-primary mb-4" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì•„ì´ë””</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ìƒí’ˆìˆ˜</th>
                            <th>ë“±ê¸‰</th>
                            <th>ì‚¬ìš©ëŸ‰</th>
                            <th>ìŠ¹ì¸</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ ìƒí’ˆ íƒ­ -->
    <div id="tab-products" class="card bg-base-100 shadow-lg hidden">
        <div class="card-body">
            <div class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="searchKeyword" placeholder="í‚¤ì›Œë“œ ë˜ëŠ” ìŠ¤í† ì–´ëª… ê²€ìƒ‰" class="input input-bordered flex-1 min-w-[200px]">
                <select id="filterUser" class="select select-bordered">
                    <option value="">ì „ì²´ ì‚¬ìš©ì</option>
                </select>
                <button class="btn btn-success" onclick="loadAllProducts()">ê²€ìƒ‰</button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ì‚¬ìš©ì</th>
                            <th>ìŠ¤í† ì–´ëª…</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>MID</th>
                            <th>í‚¤ì›Œë“œ</th>
                            <th>í˜„ì¬ìˆœìœ„</th>
                            <th>ë“±ë¡ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="productTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì¶œê¸ˆ ê´€ë¦¬ íƒ­ -->
    <div id="tab-withdrawals" class="card bg-base-100 shadow-lg hidden">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">ì¶œê¸ˆ ìš”ì²­ ëª©ë¡</h3>
                <button class="btn btn-primary btn-sm" onclick="loadWithdrawals()">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>ìš”ì²­ì¼</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ì€í–‰</th>
                            <th>ê³„ì¢Œë²ˆí˜¸</th>
                            <th>ì˜ˆê¸ˆì£¼</th>
                            <th>ìƒíƒœ</th>
                            <th>ì²˜ë¦¬ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const FREE_LIMIT = 30;

function showTab(tab) {
    // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼
    document.getElementById('tab-btn-users').classList.remove('tab-active');
    document.getElementById('tab-btn-products').classList.remove('tab-active');
    document.getElementById('tab-btn-withdrawals').classList.remove('tab-active');
    document.getElementById('tab-btn-' + tab).classList.add('tab-active');

    // íƒ­ ì½˜í…ì¸ 
    document.getElementById('tab-users').classList.add('hidden');
    document.getElementById('tab-products').classList.add('hidden');
    document.getElementById('tab-withdrawals').classList.add('hidden');
    document.getElementById('tab-' + tab).classList.remove('hidden');

    if (tab === 'products') loadAllProducts();
    if (tab === 'withdrawals') loadWithdrawals();
}

function getRoleBadge(role) {
    const badges = {
        admin: '<span class="badge badge-info">ê´€ë¦¬ì</span>',
        customer: '<span class="badge badge-success">ê³ ê°</span>',
        normal: '<span class="badge badge-ghost">ì¼ë°˜</span>'
    };
    return badges[role] || badges.normal;
}

function getRoleSelect(userId, currentRole) {
    return `
        <select class="select select-bordered select-xs" onchange="changeRole('${userId}', this.value)">
            <option value="normal" ${currentRole === 'normal' ? 'selected' : ''}>ì¼ë°˜</option>
            <option value="customer" ${currentRole === 'customer' ? 'selected' : ''}>ê³ ê°</option>
            <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
        </select>
    `;
}

function getUsageDisplay(role, productScoreUsed, brandSalesUsed) {
    if (role === 'customer' || role === 'admin') {
        return '<span class="badge badge-success badge-sm">ë¬´ì œí•œ</span>';
    }

    const psClass = productScoreUsed >= FREE_LIMIT ? 'text-error' : 'text-success';
    const bsClass = brandSalesUsed >= FREE_LIMIT ? 'text-error' : 'text-success';

    return `
        <div class="text-xs space-y-1">
            <div>ìƒí’ˆì§€ìˆ˜: <span class="${psClass} font-bold">${productScoreUsed}/${FREE_LIMIT}</span></div>
            <div>ë§¤ì¶œì¡°íšŒ: <span class="${bsClass} font-bold">${brandSalesUsed}/${FREE_LIMIT}</span></div>
        </div>
    `;
}

async function loadStats() {
    try {
        const r = await fetch('/admin/stats');
        const d = await r.json();
        if (d.success) {
            document.getElementById('stats').innerHTML = `
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì „ì²´ íšŒì›</div>
                    <div class="stat-value text-primary">${d.totalUsers}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ìŠ¹ì¸ íšŒì›</div>
                    <div class="stat-value text-success">${d.approvedUsers}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì „ì²´ ìƒí’ˆ</div>
                    <div class="stat-value text-secondary">${d.totalProducts}</div>
                </div>
                <div class="stat bg-base-100 rounded-lg shadow">
                    <div class="stat-title">ì˜¤ëŠ˜ ë“±ë¡</div>
                    <div class="stat-value text-info">${d.todayProducts}</div>
                </div>`;
        }
    } catch(e) {}
}

async function loadUsers() {
    try {
        const r = await fetch('/admin/users');
        const d = await r.json();
        if (d.success) {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';
            const select = document.getElementById('filterUser');
            select.innerHTML = '<option value="">ì „ì²´ ì‚¬ìš©ì</option>';

            d.users.forEach(u => {
                select.innerHTML += `<option value="${u.userId}">${u.userId} (${u.name})</option>`;
                const tr = document.createElement('tr');
                const role = u.role || 'normal';
                tr.innerHTML = `
                    <td>${u.userId}</td>
                    <td>${u.name}</td>
                    <td>${u.phone}</td>
                    <td>${u.regDate}</td>
                    <td>${u.productCount || 0}ê°œ</td>
                    <td>${getRoleSelect(u.userId, role)}</td>
                    <td>${getUsageDisplay(role, u.productScoreUsed || 0, u.brandSalesUsed || 0)}</td>
                    <td>
                        ${u.approved === 'Y'
                            ? '<span class="badge badge-success badge-sm">ìŠ¹ì¸ë¨</span>'
                            : '<span class="badge badge-error badge-sm">ëŒ€ê¸°ì¤‘</span>'}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                            ${u.approved === 'Y'
                                ? `<button class="btn btn-warning btn-xs" onclick="setApproval('${u.userId}','N')">ì·¨ì†Œ</button>`
                                : `<button class="btn btn-success btn-xs" onclick="setApproval('${u.userId}','Y')">ìŠ¹ì¸</button>`}
                            <button class="btn btn-ghost btn-xs" onclick="resetUsage('${u.userId}')" title="ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
                            <button class="btn btn-error btn-xs" onclick="deleteUser('${u.userId}')">ì‚­ì œ</button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function loadAllProducts() {
    try {
        const kw = document.getElementById('searchKeyword').value;
        const user = document.getElementById('filterUser').value;
        const r = await fetch(`/admin/all-products?keyword=${encodeURIComponent(kw)}&user=${encodeURIComponent(user)}`);
        const d = await r.json();

        if (d.success) {
            const tbody = document.getElementById('productTable');
            tbody.innerHTML = '';
            d.products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.userId}</td>
                    <td>${p.mall || '-'}</td>
                    <td class="max-w-[200px] truncate" title="${p.title || ''}">${p.title || '-'}</td>
                    <td>${p.mid}</td>
                    <td>${p.keyword}</td>
                    <td>${p.currentRank || '-'}</td>
                    <td>${p.createdAt || '-'}</td>`;
                tbody.appendChild(tr);
            });
            if (d.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-base-content/60">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    } catch(e) {
        alert('ë¡œë“œ ì‹¤íŒ¨');
    }
}

async function changeRole(userId, newRole) {
    try {
        const r = await fetch('/admin/role', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId, role: newRole})
        });
        const d = await r.json();
        if (d.success) {
            loadUsers();
        } else {
            alert(d.message || 'ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
            loadUsers();
        }
    } catch(e) {
        alert('ë“±ê¸‰ ë³€ê²½ ì‹¤íŒ¨');
        loadUsers();
    }
}

async function resetUsage(userId) {
    if (!confirm(`${userId} íšŒì›ì˜ ì‚¬ìš©ëŸ‰ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const r = await fetch('/admin/reset-usage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        });
        const d = await r.json();
        if (d.success) {
            alert('ì´ˆê¸°í™” ì™„ë£Œ');
            loadUsers();
        } else {
            alert(d.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨');
    }
}

async function resetAllUsage() {
    if (!confirm('âš ï¸ ì „ì²´ ì‚¬ìš©ìì˜ ì‚¬ìš©ëŸ‰ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

    try {
        const r = await fetch('/admin/reset-all-usage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const d = await r.json();
        if (d.success) {
            alert('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
            loadUsers();
        } else {
            alert(d.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨');
    }
}

async function setApproval(id, ap) {
    const r = await fetch('/admin/approve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id, approved: ap})
    });
    const d = await r.json();
    if (d.success) loadUsers();
    else alert(d.message);
}

async function deleteUser(id) {
    if (!confirm(id + ' íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const r = await fetch('/admin/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: id})
    });
    const d = await r.json();
    if (d.success) {
        loadUsers();
        loadStats();
    } else alert(d.message);
}

document.getElementById('searchKeyword').addEventListener('keypress', e => {
    if (e.key === 'Enter') loadAllProducts();
});

// ===== ì¶œê¸ˆ ê´€ë¦¬ =====

async function loadPendingCount() {
    try {
        const r = await fetch('/admin/withdrawals/pending-count');
        const d = await r.json();
        if (d.success) {
            const badge = document.getElementById('withdrawalBadge');
            if (d.count > 0) {
                badge.textContent = d.count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    } catch(e) {}
}

async function loadWithdrawals() {
    try {
        const r = await fetch('/admin/withdrawals');
        const d = await r.json();
        if (d.success) {
            const tbody = document.getElementById('withdrawalTable');
            tbody.innerHTML = '';

            d.withdrawals.forEach(w => {
                const tr = document.createElement('tr');
                const statusBadge = getStatusBadge(w.status);
                const actionBtns = w.status === 'pending' ? `
                    <button class="btn btn-success btn-xs" onclick="processWithdrawal(${w.id}, 'approved')">ìŠ¹ì¸</button>
                    <button class="btn btn-error btn-xs" onclick="processWithdrawal(${w.id}, 'rejected')">ê±°ì ˆ</button>
                ` : '-';

                tr.innerHTML = `
                    <td>${w.requestedAt}</td>
                    <td>${w.userName} (${w.userId})</td>
                    <td class="font-bold">${formatNumber(w.amount)}ì›</td>
                    <td>${w.bankName}</td>
                    <td>${w.accountNumber}</td>
                    <td>${w.accountHolder}</td>
                    <td>${statusBadge}</td>
                    <td>${w.processedAt || '-'}</td>
                    <td>${actionBtns}</td>
                `;
                tbody.appendChild(tr);
            });

            if (d.withdrawals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-10 text-base-content/60">ì¶œê¸ˆ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }

            loadPendingCount();
        }
    } catch(e) {
        alert('ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
    }
}

function getStatusBadge(status) {
    const badges = {
        pending: '<span class="badge badge-warning badge-sm">ëŒ€ê¸°ì¤‘</span>',
        approved: '<span class="badge badge-success badge-sm">ìŠ¹ì¸</span>',
        rejected: '<span class="badge badge-error badge-sm">ê±°ì ˆ</span>'
    };
    return badges[status] || status;
}

async function processWithdrawal(id, status) {
    const statusText = status === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
    const memo = status === 'rejected' ? prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):') : '';

    if (!confirm(`ì´ ì¶œê¸ˆ ìš”ì²­ì„ ${statusText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const r = await fetch('/admin/withdrawals/process', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id, status: status, memo: memo || ''})
        });
        const d = await r.json();
        if (d.success) {
            alert(`${statusText} ì™„ë£Œ`);
            loadWithdrawals();
        } else {
            alert(d.message || 'ì²˜ë¦¬ ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì²˜ë¦¬ ì‹¤íŒ¨');
    }
}

function formatNumber(n) {
    return (n || 0).toLocaleString();
}

loadStats();
loadUsers();
loadPendingCount();
</script>
</body>
</html>
