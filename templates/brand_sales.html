{% extends "base.html" %}

{% block title %}ë¸Œëœë“œ ë§¤ì¶œ ì¡°íšŒ{% endblock %}

{% block header_title %}ğŸ’° ë¸Œëœë“œ ë§¤ì¶œ ì¡°íšŒ{% endblock %}

{% block extra_css %}
<style>
.summary-boxes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.summary-box {
    padding: 20px;
    border-radius: 12px;
    color: white;
    text-align: center;
}
.summary-box .label {
    display: block;
    font-size: 13px;
    opacity: 0.9;
    margin-bottom: 8px;
}
.summary-box .value {
    display: block;
    font-size: 24px;
    font-weight: bold;
}
.product-name {
    text-align: left !important;
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>ğŸ” ìŠ¤í† ì–´ ë§¤ì¶œ ì¡°íšŒ</h3></div>
    <div class="card-body">
        <div class="search-box" style="margin-bottom:15px">
            <input type="text" id="storeUrl" placeholder="https://brand.naver.com/ìŠ¤í† ì–´ëª… ë˜ëŠ” ìƒí’ˆ URL" style="flex:2">
            <select id="period" style="width:120px;padding:10px;border:1px solid #ddd;border-radius:8px">
                <option value="daily">ì¼ê°„</option>
                <option value="weekly">ì£¼ê°„</option>
                <option value="monthly">ì›”ê°„</option>
            </select>
            <button onclick="searchSales()" id="searchBtn">ì¡°íšŒí•˜ê¸°</button>
        </div>
        <p style="font-size:12px;color:#888">* ë¸Œëœë“œìŠ¤í† ì–´/ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ URL ì…ë ¥ (ìƒí’ˆ URL ë„£ìœ¼ë©´ ìŠ¤í† ì–´ ë©”ì¸ìœ¼ë¡œ ìë™ ë³€í™˜)<br>* ìœˆë„ìš° ë¡œì»¬ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤</p>
    </div>
</div>

<div id="resultArea" style="display:none">
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“Š ë§¤ì¶œ ê²°ê³¼ <span id="productCount" style="color:#667eea"></span></h3>
        </div>
        <div class="card-body">
            <!-- ë§¤ì¶œ ìš”ì•½ -->
            <div class="summary-boxes" id="summaryBoxes">
                <div class="summary-box" style="background:linear-gradient(135deg,#667eea,#764ba2)">
                    <span class="label">ğŸ’° ì´ ë§¤ì¶œ</span>
                    <span class="value" id="totalAmount">0ì›</span>
                </div>
                <div class="summary-box" style="background:linear-gradient(135deg,#11998e,#38ef7d)">
                    <span class="label">ğŸ“¦ ì´ íŒë§¤</span>
                    <span class="value" id="totalCount">0ê±´</span>
                </div>
                <div class="summary-box" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
                    <span class="label">ğŸ‘† ì´ í´ë¦­</span>
                    <span class="value" id="totalClicks">0íšŒ</span>
                </div>
            </div>
            
            <p id="storeUrlDisplay" style="margin:15px 0;color:#888;font-size:13px"></p>
            
            <!-- ìƒí’ˆ í…Œì´ë¸” -->
            <div class="table-scroll">
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>íŒë§¤ìˆ˜</th>
                            <th>í´ë¦­ìˆ˜</th>
                            <th>ì „í™˜ìœ¨</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="loading" style="display:none">
    <div class="spinner"></div>
    <p>ë§¤ì¶œ ë°ì´í„° ì¡°íšŒ ì¤‘...</p>
</div>

<div id="errorArea" style="display:none" class="card">
    <div class="card-body" style="text-align:center;padding:40px;color:#c00">
        <div style="font-size:40px;margin-bottom:15px">âŒ</div>
        <p id="errorMsg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const RANK_API_URL = '{{ rank_api_url }}';

async function searchSales() {
    const url = document.getElementById('storeUrl').value.trim();
    const period = document.getElementById('period').value;
    const btn = document.getElementById('searchBtn');
    
    if (!url) {
        alert('ìŠ¤í† ì–´ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!url.includes('naver.com')) {
        alert('ë„¤ì´ë²„ ìŠ¤í† ì–´ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(brand.naver.com ë˜ëŠ” smartstore.naver.com)');
        return;
    }
    
    // UI ì´ˆê¸°í™”
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('errorArea').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    btn.disabled = true;
    btn.textContent = 'ì¡°íšŒ ì¤‘...';
    
    try {
        const apiUrl = RANK_API_URL + '/api/brand-sales?store_url=' + encodeURIComponent(url) + '&period=' + period;
        const r = await fetch(apiUrl, {
            method: 'GET',
            mode: 'cors',
            headers: {'Accept': 'application/json'}
        });
        const d = await r.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (d.success) {
            displayResults(d);
        } else {
            document.getElementById('errorArea').style.display = 'block';
            document.getElementById('errorMsg').textContent = d.error || 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
    } catch(e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('errorArea').style.display = 'block';
        document.getElementById('errorMsg').textContent = 'ë¡œì»¬ ì„œë²„ ì—°ê²° ì‹¤íŒ¨\n\nìœˆë„ìš°ì—ì„œ integrated_server.pyê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì¡°íšŒí•˜ê¸°';
    }
}

function displayResults(data) {
    document.getElementById('resultArea').style.display = 'block';
    
    // ìš”ì•½ ì •ë³´
    const summary = data.summary || {};
    document.getElementById('totalAmount').textContent = formatNumber(summary.total_amount || 0) + 'ì›';
    document.getElementById('totalCount').textContent = formatNumber(summary.total_count || 0) + 'ê±´';
    document.getElementById('totalClicks').textContent = formatNumber(summary.total_clicks || 0) + 'íšŒ';
    
    // ìƒí’ˆ ìˆ˜
    const products = data.products || [];
    document.getElementById('productCount').textContent = '(' + products.length + 'ê°œ ìƒí’ˆ)';
    document.getElementById('storeUrlDisplay').innerHTML = 'ğŸ“ ' + (data.store_url || '');
    
    // í…Œì´ë¸” ë Œë”ë§
    const tbody = document.getElementById('salesBody');
    tbody.innerHTML = '';
    
    products.forEach((p, idx) => {
        const tr = document.createElement('tr');
        const convRate = p.clicks > 0 ? ((p.count / p.clicks) * 100).toFixed(1) : '0.0';
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="product-name" title="${p.name || ''}">${p.name || '-'}</td>
            <td>${formatNumber(p.amount)}ì›</td>
            <td>${formatNumber(p.count)}ê±´</td>
            <td>${formatNumber(p.clicks)}íšŒ</td>
            <td>${convRate}%</td>
        `;
        tbody.appendChild(tr);
    });
    
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding:40px;color:#888">ì¡°íšŒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
}

// Enter í‚¤ë¡œ ì¡°íšŒ
document.getElementById('storeUrl').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchSales();
});
</script>
{% endblock %}
