{% extends "base.html" %}

{% block title %}브랜드 매출{% endblock %}

{% block extra_css %}
<style>
.search-box {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.search-box .input {
    flex: 1;
    min-width: 150px;
}
.select {
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
    outline: none;
    background: #fff;
    min-width: 80px;
}
.select:focus {
    border-color: var(--primary);
}
.status-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 12px;
    font-size: 0.75rem;
    color: var(--text-gray);
}
.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}
.summary-card {
    background: var(--bg-gray);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.summary-card .label {
    font-size: 0.688rem;
    color: var(--text-gray);
    margin-bottom: 4px;
}
.summary-card .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-dark);
}
.summary-card.primary {
    background: rgba(99, 102, 241, 0.1);
}
.summary-card.primary .value {
    color: var(--primary);
}
.hint {
    font-size: 0.688rem;
    color: var(--text-gray);
}
.store-url {
    font-size: 0.75rem;
    color: var(--text-gray);
    margin-bottom: 12px;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
}
.data-table th, .data-table td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}
.data-table th {
    font-weight: 600;
    color: var(--text-gray);
    background: var(--bg-gray);
}
.error-box {
    text-align: center;
    padding: 48px 16px;
    color: #EF4444;
}
</style>
{% endblock %}

{% block content %}
<!-- 상태 표시 -->
<div class="status-bar">
    <span id="usageInfo"></span>
</div>

<!-- 업그레이드 알림 -->
<div id="upgradeNotice" class="alert alert-warning hidden">
    무료 사용 횟수를 모두 사용했습니다.
</div>

<!-- 검색 -->
<div class="card">
    <div class="search-box">
        <input type="text" id="storeUrl" placeholder="스토어 URL 입력" class="input">
        <select id="period" class="select">
            <option value="daily">일간</option>
            <option value="weekly">주간</option>
            <option value="monthly">월간</option>
        </select>
        <button onclick="searchSales()" id="searchBtn" class="btn btn-primary">조회</button>
    </div>
    <p class="hint">* 로컬 서버 필요</p>
</div>

<!-- 로딩 -->
<div id="loading" class="flex flex-col items-center py-8 hidden">
    <div class="spinner"></div>
    <p class="mt-4 text-sm text-gray">조회 중...</p>
</div>

<!-- 결과 영역 -->
<div id="resultArea" class="hidden">
    <div class="card">
        <!-- 매출 요약 -->
        <div class="summary-grid">
            <div class="summary-card primary">
                <div class="label">총 매출</div>
                <div class="value" id="totalAmount">0원</div>
            </div>
            <div class="summary-card">
                <div class="label">총 판매</div>
                <div class="value" id="totalCount">0건</div>
            </div>
            <div class="summary-card">
                <div class="label">총 클릭</div>
                <div class="value" id="totalClicks">0회</div>
            </div>
        </div>

        <p id="storeUrlDisplay" class="store-url"></p>
        <div class="flex items-center gap-2 mb-3">
            <p id="productCount" class="text-xs text-gray"></p>
            <button id="downloadCsvBtn" onclick="downloadCsv()" class="btn btn-ghost" style="padding: 6px 12px; font-size: 0.75rem;">CSV 다운로드</button>
        </div>

        <!-- 상품 테이블 -->
        <div style="overflow-x:auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>상품명</th>
                        <th>매출액</th>
                        <th>판매</th>
                        <th>클릭</th>
                        <th>전환율</th>
                    </tr>
                </thead>
                <tbody id="salesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 에러 영역 -->
<div id="errorArea" class="hidden">
    <div class="card error-box">
        <p id="errorMsg">오류가 발생했습니다.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const RANK_API_URL = '{{ rank_api_url }}';
let canUseService = true;
let currentProducts = [];
let currentSummary = {};
let currentStoreUrl = '';

function getUserFriendlyError(error) {
    if (!error) return '조회에 실패했습니다.';

    // 기술적인 용어가 포함된 에러를 친절한 메시지로 변환
    const errorLower = error.toLowerCase();
    if (errorLower.includes('mallseq') || errorLower.includes('mall_seq')) {
        return '스토어 정보를 찾을 수 없습니다. URL을 확인해주세요.';
    }
    if (errorLower.includes('not found') || errorLower.includes('찾을 수 없')) {
        return '스토어 정보를 찾을 수 없습니다. URL을 확인해주세요.';
    }
    if (errorLower.includes('timeout') || errorLower.includes('시간 초과')) {
        return '서버 응답 시간이 초과되었습니다. 다시 시도해주세요.';
    }
    if (errorLower.includes('network') || errorLower.includes('connection')) {
        return '네트워크 연결에 실패했습니다.';
    }
    if (errorLower.includes('invalid') || errorLower.includes('유효하지')) {
        return '올바르지 않은 URL입니다. 스토어 URL을 확인해주세요.';
    }

    // 기술적인 용어가 포함되어 있으면 일반 메시지로 대체
    if (/[a-zA-Z_]{3,}/.test(error) && error.includes('를 찾을 수 없')) {
        return '스토어 정보를 찾을 수 없습니다. URL을 확인해주세요.';
    }

    return '조회에 실패했습니다. 다시 시도해주세요.';
}

async function checkUsage() {
    try {
        const r = await fetch('/api/brand-sales/check-usage');
        const d = await r.json();
        if (d.success) updateUsageDisplay(d);
    } catch(e) {
        console.error('사용량 체크 실패:', e);
    }
}

function updateUsageDisplay(data) {
    const usageInfo = document.getElementById('usageInfo');
    const upgradeNotice = document.getElementById('upgradeNotice');
    const searchBtn = document.getElementById('searchBtn');

    if (data.limit === -1) {
        usageInfo.textContent = '무제한';
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else if (data.canUse) {
        usageInfo.textContent = `남은 횟수: ${data.remaining}/${data.limit}`;
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else {
        usageInfo.textContent = `사용 완료 (${data.used}/${data.limit})`;
        canUseService = false;
        upgradeNotice.classList.remove('hidden');
        searchBtn.disabled = true;
    }
}

async function searchSales() {
    const url = document.getElementById('storeUrl').value.trim();
    const period = document.getElementById('period').value;
    const btn = document.getElementById('searchBtn');

    if (!url) { alert('URL을 입력해주세요.'); return; }
    if (!url.includes('naver.com')) { alert('네이버 스토어 URL을 입력해주세요.'); return; }
    if (!canUseService) { alert('사용 횟수를 모두 사용했습니다.'); return; }

    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('errorArea').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    btn.disabled = true;
    btn.textContent = '조회중...';

    try {
        const apiUrl = RANK_API_URL + '/api/brand-sales?store_url=' + encodeURIComponent(url) + '&period=' + period;
        const r = await fetch(apiUrl, {
            method: 'GET', mode: 'cors', headers: {'Accept': 'application/json'}
        });
        const d = await r.json();

        document.getElementById('loading').classList.add('hidden');

        if (d.success) {
            await fetch('/api/brand-sales/use', { method: 'POST' });
            await checkUsage();
            displayResults(d);
        } else {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMsg').textContent = getUserFriendlyError(d.error);
        }
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('errorArea').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = '로컬 서버 연결 실패';
    } finally {
        btn.disabled = false;
        btn.textContent = '조회';
    }
}

function displayResults(data) {
    document.getElementById('resultArea').classList.remove('hidden');

    const summary = data.summary || {};
    currentSummary = summary;
    currentStoreUrl = data.store_url || '';
    document.getElementById('totalAmount').textContent = formatNumber(summary.total_amount || 0) + '원';
    document.getElementById('totalCount').textContent = formatNumber(summary.total_count || 0) + '건';
    document.getElementById('totalClicks').textContent = formatNumber(summary.total_clicks || 0) + '회';

    const products = data.products || [];
    currentProducts = products;
    document.getElementById('productCount').textContent = products.length + '개 상품';
    document.getElementById('storeUrlDisplay').textContent = data.store_url || '';

    const tbody = document.getElementById('salesBody');
    tbody.innerHTML = '';

    products.forEach((p, idx) => {
        const tr = document.createElement('tr');
        const convRate = p.clicks > 0 ? ((p.count / p.clicks) * 100).toFixed(1) : '0.0';
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="truncate" style="max-width:150px" title="${p.name || ''}">${p.name || '-'}</td>
            <td>${formatNumber(p.amount)}원</td>
            <td>${formatNumber(p.count)}</td>
            <td>${formatNumber(p.clicks)}</td>
            <td>${convRate}%</td>
        `;
        tbody.appendChild(tr);
    });

    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-gray);padding:32px">데이터 없음</td></tr>';
    }
}

document.getElementById('storeUrl').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchSales();
});

function downloadCsv() {
    if (currentProducts.length === 0) {
        alert('다운로드할 데이터가 없습니다.');
        return;
    }

    const headers = ['순번', '상품명', '매출액', '판매수', '클릭수', '전환율(%)'];

    const rows = currentProducts.map((p, idx) => {
        const convRate = p.clicks > 0 ? ((p.count / p.clicks) * 100).toFixed(1) : '0.0';
        return [
            idx + 1,
            `"${(p.name || '').replace(/"/g, '""')}"`,
            p.amount || 0,
            p.count || 0,
            p.clicks || 0,
            convRate
        ];
    });

    // 요약 정보 추가
    rows.push([]);
    rows.push(['[요약]']);
    rows.push(['총 매출', currentSummary.total_amount || 0]);
    rows.push(['총 판매', currentSummary.total_count || 0]);
    rows.push(['총 클릭', currentSummary.total_clicks || 0]);

    const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `브랜드매출_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

checkUsage();
</script>
{% endblock %}
