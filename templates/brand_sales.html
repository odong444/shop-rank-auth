{% extends "base.html" %}

{% block title %}ìŠ¤í† ì–´ ë§¤ì¶œ{% endblock %}

{% block extra_css %}
<style>
.search-box {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.search-box .input {
    flex: 1;
    min-width: 150px;
}
.select {
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
    outline: none;
    background: #fff;
    min-width: 80px;
}
.select:focus {
    border-color: var(--primary);
}
.status-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 12px;
    font-size: 0.75rem;
    color: var(--text-gray);
}
.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}
.summary-card {
    background: var(--bg-gray);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.summary-card .label {
    font-size: 0.688rem;
    color: var(--text-gray);
    margin-bottom: 4px;
}
.summary-card .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-dark);
}
.summary-card.primary {
    background: rgba(99, 102, 241, 0.1);
}
.summary-card.primary .value {
    color: var(--primary);
}
.hint {
    font-size: 0.688rem;
    color: var(--text-gray);
}
.store-url {
    font-size: 0.75rem;
    color: var(--text-gray);
    margin-bottom: 12px;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
}
.data-table th, .data-table td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}
.data-table th {
    font-weight: 600;
    color: var(--text-gray);
    background: var(--bg-gray);
}
.error-box {
    text-align: center;
    padding: 48px 16px;
    color: #EF4444;
}
</style>
{% endblock %}

{% block content %}
<!-- ìƒíƒœ í‘œì‹œ -->
<div class="status-bar">
    <span id="usageInfo"></span>
</div>

<!-- ì—…ê·¸ë ˆì´ë“œ ì•Œë¦¼ -->
<div id="upgradeNotice" class="alert alert-warning hidden">
    ë¬´ë£Œ ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
</div>

<!-- ê²€ìƒ‰ -->
<div class="card">
    <div class="search-box">
        <input type="text" id="storeUrl" placeholder="ìŠ¤í† ì–´ URL ì…ë ¥" class="input">
        <select id="period" class="select">
            <option value="daily">ì¼ê°„</option>
            <option value="weekly">ì£¼ê°„</option>
            <option value="monthly">ì›”ê°„</option>
        </select>
        <button onclick="searchSales()" id="searchBtn" class="btn btn-primary">ì¡°íšŒ</button>
    </div>
    <p class="hint">* ë¡œì»¬ ì„œë²„ í•„ìš”</p>
</div>

<!-- ë¡œë”© -->
<div id="loading" class="flex flex-col items-center py-8 hidden">
    <div class="spinner"></div>
    <p class="mt-4 text-sm text-gray">ì¡°íšŒ ì¤‘...</p>
</div>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultArea" class="hidden">
    <div class="card">
        <!-- ë§¤ì¶œ ìš”ì•½ -->
        <div class="summary-grid">
            <div class="summary-card primary">
                <div class="label">ì´ ë§¤ì¶œ</div>
                <div class="value" id="totalAmount">0ì›</div>
            </div>
            <div class="summary-card">
                <div class="label">ì´ íŒë§¤</div>
                <div class="value" id="totalCount">0ê±´</div>
            </div>
            <div class="summary-card">
                <div class="label">ì´ í´ë¦­</div>
                <div class="value" id="totalClicks">0íšŒ</div>
            </div>
        </div>

        <div class="flex items-center justify-between mb-3">
            <div>
                <p id="storeUrlDisplay" class="store-url" style="margin-bottom: 4px;"></p>
                <p id="periodDisplay" class="text-xs" style="color: var(--primary); font-weight: 600; margin-bottom: 0;"></p>
            </div>
            <button id="downloadCsvBtn" onclick="downloadCsv()" class="btn btn-ghost" style="padding: 6px 12px; font-size: 0.75rem;">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <p id="productCount" class="text-xs text-gray mb-3"></p>

        <!-- ìƒí’ˆ í…Œì´ë¸” -->
        <div style="overflow-x:auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ë§¤ì¶œì•¡</th>
                        <th>íŒë§¤</th>
                        <th>í´ë¦­</th>
                        <th>ì „í™˜ìœ¨</th>
                    </tr>
                </thead>
                <tbody id="salesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ì—ëŸ¬ ì˜ì—­ -->
<div id="errorArea" class="hidden">
    <div class="card error-box">
        <p id="errorMsg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const RANK_API_URL = '{{ rank_api_url }}';
let canUseService = true;
let currentProducts = [];
let currentSummary = {};
let currentStoreUrl = '';

function getPeriodText(period) {
    const today = new Date();
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}.${month}.${day}`;
    };

    if (period === 'daily') {
        // ì–´ì œ í•˜ë£¨
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        return `ğŸ“… ì¡°íšŒ ê¸°ì¤€: ì–´ì œ (${formatDate(yesterday)})`;
    } else if (period === 'weekly') {
        // ì§€ë‚œì£¼ ì›”~ì¼ (ê°€ì¥ ìµœê·¼ ì™„ë£Œëœ ì£¼)
        const daysSinceMonday = today.getDay() === 0 ? 6 : today.getDay() - 1; // ì¼ìš”ì¼=0 ì²˜ë¦¬
        const lastSunday = new Date(today);
        lastSunday.setDate(today.getDate() - daysSinceMonday - 1);
        const lastMonday = new Date(lastSunday);
        lastMonday.setDate(lastSunday.getDate() - 6);
        return `ğŸ“… ì¡°íšŒ ê¸°ì¤€: ì§€ë‚œì£¼ (${formatDate(lastMonday)} ~ ${formatDate(lastSunday)})`;
    } else if (period === 'monthly') {
        // ì§€ë‚œë‹¬ 1ì¼ ~ ë§ì¼
        const firstOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastOfPrevMonth = new Date(firstOfThisMonth);
        lastOfPrevMonth.setDate(0); // ì´ì „ ë‹¬ ë§ˆì§€ë§‰ ë‚ 
        const firstOfPrevMonth = new Date(lastOfPrevMonth.getFullYear(), lastOfPrevMonth.getMonth(), 1);
        return `ğŸ“… ì¡°íšŒ ê¸°ì¤€: ì§€ë‚œë‹¬ (${formatDate(firstOfPrevMonth)} ~ ${formatDate(lastOfPrevMonth)})`;
    }
    return '';
}

function getUserFriendlyError(error) {
    if (!error) return 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

    // ê¸°ìˆ ì ì¸ ìš©ì–´ê°€ í¬í•¨ëœ ì—ëŸ¬ë¥¼ ì¹œì ˆí•œ ë©”ì‹œì§€ë¡œ ë³€í™˜
    const errorLower = error.toLowerCase();
    if (errorLower.includes('mallseq') || errorLower.includes('mall_seq')) {
        return 'ìŠ¤í† ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    }
    if (errorLower.includes('not found') || errorLower.includes('ì°¾ì„ ìˆ˜ ì—†')) {
        return 'ìŠ¤í† ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    }
    if (errorLower.includes('timeout') || errorLower.includes('ì‹œê°„ ì´ˆê³¼')) {
        return 'ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    if (errorLower.includes('network') || errorLower.includes('connection')) {
        return 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    }
    if (errorLower.includes('invalid') || errorLower.includes('ìœ íš¨í•˜ì§€')) {
        return 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ URLì…ë‹ˆë‹¤. ìŠ¤í† ì–´ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    }

    // ê¸°ìˆ ì ì¸ ìš©ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì¼ë°˜ ë©”ì‹œì§€ë¡œ ëŒ€ì²´
    if (/[a-zA-Z_]{3,}/.test(error) && error.includes('ë¥¼ ì°¾ì„ ìˆ˜ ì—†')) {
        return 'ìŠ¤í† ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    }

    return 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
}

async function checkUsage() {
    try {
        const r = await fetch('/api/brand-sales/check-usage');
        const d = await r.json();
        if (d.success) updateUsageDisplay(d);
    } catch(e) {
        console.error('ì‚¬ìš©ëŸ‰ ì²´í¬ ì‹¤íŒ¨:', e);
    }
}

function updateUsageDisplay(data) {
    const usageInfo = document.getElementById('usageInfo');
    const upgradeNotice = document.getElementById('upgradeNotice');
    const searchBtn = document.getElementById('searchBtn');

    if (data.limit === -1) {
        usageInfo.textContent = 'ë¬´ì œí•œ';
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else if (data.canUse) {
        usageInfo.textContent = `ë‚¨ì€ íšŸìˆ˜: ${data.remaining}/${data.limit}`;
        canUseService = true;
        upgradeNotice.classList.add('hidden');
        searchBtn.disabled = false;
    } else {
        usageInfo.textContent = `ì‚¬ìš© ì™„ë£Œ (${data.used}/${data.limit})`;
        canUseService = false;
        upgradeNotice.classList.remove('hidden');
        searchBtn.disabled = true;
    }
}

async function searchSales() {
    const url = document.getElementById('storeUrl').value.trim();
    const period = document.getElementById('period').value;
    const btn = document.getElementById('searchBtn');

    if (!url) { alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (!url.includes('naver.com')) { alert('ë„¤ì´ë²„ ìŠ¤í† ì–´ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (!canUseService) { alert('ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.'); return; }

    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('errorArea').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    btn.disabled = true;
    btn.textContent = 'ì¡°íšŒì¤‘...';

    try {
        const apiUrl = RANK_API_URL + '/api/brand-sales?store_url=' + encodeURIComponent(url) + '&period=' + period;
        const r = await fetch(apiUrl, {
            method: 'GET', mode: 'cors', headers: {'Accept': 'application/json'}
        });
        const d = await r.json();

        document.getElementById('loading').classList.add('hidden');

        if (d.success) {
            await fetch('/api/brand-sales/use', { method: 'POST' });
            await checkUsage();
            displayResults(d);
        } else {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMsg').textContent = getUserFriendlyError(d.error);
        }
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('errorArea').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = 'ë¡œì»¬ ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì¡°íšŒ';
    }
}

function displayResults(data) {
    document.getElementById('resultArea').classList.remove('hidden');

    const summary = data.summary || {};
    currentSummary = summary;
    currentStoreUrl = data.store_url || '';
    document.getElementById('totalAmount').textContent = formatNumber(summary.total_amount || 0) + 'ì›';
    document.getElementById('totalCount').textContent = formatNumber(summary.total_count || 0) + 'ê±´';
    document.getElementById('totalClicks').textContent = formatNumber(summary.total_clicks || 0) + 'íšŒ';

    const products = data.products || [];
    currentProducts = products;
    document.getElementById('productCount').textContent = products.length + 'ê°œ ìƒí’ˆ';
    document.getElementById('storeUrlDisplay').textContent = data.store_url || '';

    // ì¡°íšŒ ê¸°ê°„ í‘œì‹œ
    const period = document.getElementById('period').value;
    const periodText = getPeriodText(period);
    document.getElementById('periodDisplay').textContent = periodText;

    const tbody = document.getElementById('salesBody');
    tbody.innerHTML = '';

    products.forEach((p, idx) => {
        const tr = document.createElement('tr');
        const convRate = p.clicks > 0 ? ((p.count / p.clicks) * 100).toFixed(1) : '0.0';
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="truncate" style="max-width:150px" title="${p.name || ''}">${p.name || '-'}</td>
            <td>${formatNumber(p.amount)}ì›</td>
            <td>${formatNumber(p.count)}</td>
            <td>${formatNumber(p.clicks)}</td>
            <td>${convRate}%</td>
        `;
        tbody.appendChild(tr);
    });

    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-gray);padding:32px">ë°ì´í„° ì—†ìŒ</td></tr>';
    }
}

document.getElementById('storeUrl').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchSales();
});

function downloadCsv() {
    if (currentProducts.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const period = document.getElementById('period').value;
    const periodText = getPeriodText(period).replace('ğŸ“… ì¡°íšŒ ê¸°ì¤€: ', '');

    const headers = ['ìˆœë²ˆ', 'ìƒí’ˆëª…', 'ë§¤ì¶œì•¡', 'íŒë§¤ìˆ˜', 'í´ë¦­ìˆ˜', 'ì „í™˜ìœ¨(%)'];

    const rows = currentProducts.map((p, idx) => {
        const convRate = p.clicks > 0 ? ((p.count / p.clicks) * 100).toFixed(1) : '0.0';
        return [
            idx + 1,
            `"${(p.name || '').replace(/"/g, '""')}"`,
            p.amount || 0,
            p.count || 0,
            p.clicks || 0,
            convRate
        ];
    });

    // ìš”ì•½ ì •ë³´ ì¶”ê°€
    rows.push([]);
    rows.push(['[ìš”ì•½]']);
    rows.push(['ì¡°íšŒ ê¸°ê°„', `"${periodText}"`]);
    rows.push(['ì´ ë§¤ì¶œ', currentSummary.total_amount || 0]);
    rows.push(['ì´ íŒë§¤', currentSummary.total_count || 0]);
    rows.push(['ì´ í´ë¦­', currentSummary.total_clicks || 0]);

    const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `ë¸Œëœë“œë§¤ì¶œ_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

checkUsage();
</script>
{% endblock %}
