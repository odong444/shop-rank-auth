{% extends "base.html" %}

{% block title %}쿠팡 순위추적{% endblock %}

{% block extra_css %}
<style>
.search-box {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.search-box .input {
    flex: 1;
    min-width: 150px;
}
.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    margin-bottom: 12px;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #EF4444;
}
.status-dot.online {
    background: #10B981;
}
.result-card {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    background: #fff;
}
.result-header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 8px;
}
.result-rank {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--coupang);
    color: #fff;
    font-weight: 700;
    font-size: 0.875rem;
    border-radius: 8px;
    flex-shrink: 0;
}
.result-rank.top3 {
    background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
}
.result-info {
    flex: 1;
    min-width: 0;
}
.result-title {
    font-size: 0.813rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.result-brand {
    font-size: 0.688rem;
    color: var(--text-gray);
}
.result-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 8px;
}
.stat-item {
    text-align: center;
    padding: 8px;
    background: var(--bg-gray);
    border-radius: 6px;
}
.stat-label {
    font-size: 0.625rem;
    color: var(--text-gray);
    margin-bottom: 2px;
}
.stat-value {
    font-size: 0.813rem;
    font-weight: 700;
    color: var(--text-dark);
}
.stat-value.sales {
    color: var(--coupang);
}
.hint {
    font-size: 0.688rem;
    color: var(--text-gray);
}
.error-box {
    text-align: center;
    padding: 48px 16px;
    color: #EF4444;
}
.empty-state {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-gray);
}
</style>
{% endblock %}

{% block content %}
<!-- API 상태 -->
<div class="status-indicator">
    <div id="statusDot" class="status-dot"></div>
    <span id="statusText">연결 확인 중...</span>
</div>

<!-- 검색 -->
<div class="card">
    <div class="search-box">
        <input type="text" id="keyword" placeholder="검색 키워드 입력" class="input">
        <button onclick="searchRank()" id="searchBtn" class="btn btn-primary">검색</button>
    </div>
    <p class="hint">* 쿠팡 로컬 서버 연결 필요</p>
</div>

<!-- 로딩 -->
<div id="loading" class="flex flex-col items-center py-8 hidden">
    <div class="spinner"></div>
    <p class="mt-4 text-sm text-gray">검색 중...</p>
</div>

<!-- 결과 영역 -->
<div id="resultArea" class="hidden">
    <div class="flex justify-between items-center mb-3">
        <p id="resultCount" class="text-sm font-semibold"></p>
        <p id="searchKeyword" class="text-xs text-gray"></p>
    </div>
    <div id="resultList"></div>
</div>

<!-- 에러 영역 -->
<div id="errorArea" class="hidden">
    <div class="card error-box">
        <p id="errorMsg">오류가 발생했습니다.</p>
    </div>
</div>

<!-- 빈 상태 -->
<div id="emptyState" class="hidden">
    <div class="card empty-state">
        <p>키워드를 입력하고 검색하세요</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function checkApiStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');

    try {
        const r = await fetch('/api/coupang/health');
        const d = await r.json();

        if (d.success && d.status === 'online') {
            dot.classList.add('online');
            text.textContent = '서버 연결됨';
        } else if (d.status === 'not_configured') {
            text.textContent = 'API 미설정';
        } else {
            text.textContent = '서버 오프라인';
        }
    } catch(e) {
        text.textContent = '연결 확인 실패';
    }
}

async function searchRank() {
    const keyword = document.getElementById('keyword').value.trim();
    const btn = document.getElementById('searchBtn');

    if (!keyword) {
        alert('키워드를 입력해주세요.');
        return;
    }

    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('errorArea').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    btn.disabled = true;
    btn.textContent = '검색중...';

    try {
        const r = await fetch('/api/coupang/search?keyword=' + encodeURIComponent(keyword));
        const d = await r.json();

        document.getElementById('loading').classList.add('hidden');

        if (d.success) {
            displayResults(keyword, d.data || d.result || []);
        } else {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMsg').textContent = d.message || '검색에 실패했습니다.';
        }
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('errorArea').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = '서버 연결 실패';
    } finally {
        btn.disabled = false;
        btn.textContent = '검색';
    }
}

function displayResults(keyword, results) {
    document.getElementById('resultArea').classList.remove('hidden');
    document.getElementById('resultCount').textContent = `${results.length}개 상품`;
    document.getElementById('searchKeyword').textContent = `"${keyword}" 검색결과`;

    const list = document.getElementById('resultList');
    list.innerHTML = '';

    if (results.length === 0) {
        list.innerHTML = '<div class="card empty-state"><p>검색 결과가 없습니다.</p></div>';
        return;
    }

    results.forEach((item, idx) => {
        const rank = idx + 1;
        const card = document.createElement('div');
        card.className = 'result-card';

        card.innerHTML = `
            <div class="result-header">
                <div class="result-rank ${rank <= 3 ? 'top3' : ''}">${rank}</div>
                <div class="result-info">
                    <div class="result-title">${item.productName || item.itemName || '-'}</div>
                    <div class="result-brand">${item.brandName || '-'}</div>
                </div>
            </div>
            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-label">판매가</div>
                    <div class="stat-value">${formatNumber(item.salePrice || 0)}원</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">28일 판매량</div>
                    <div class="stat-value sales">${formatNumber(item.salesLast28d || 0)}개</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">28일 조회수</div>
                    <div class="stat-value">${formatNumber(item.pvLast28Day || 0)}</div>
                </div>
            </div>
        `;

        // 클릭 시 쿠팡 상품 페이지 열기
        if (item.productId) {
            card.style.cursor = 'pointer';
            card.onclick = () => {
                const url = `https://www.coupang.com/vp/products/${item.productId}`;
                window.open(url, '_blank');
            };
        }

        list.appendChild(card);
    });
}

document.getElementById('keyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchRank();
});

checkApiStatus();
</script>
{% endblock %}
